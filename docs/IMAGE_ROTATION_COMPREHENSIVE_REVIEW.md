# ğŸ–¼ï¸ å›¾ç‰‡æ—‹è½¬åŠŸèƒ½å…¨é¢å®¡æŸ¥æŠ¥å‘Š

## ğŸ“‹ å®¡æŸ¥èŒƒå›´

å…¨é¢å®¡æŸ¥å›¾ç‰‡æ—‹è½¬åŠŸèƒ½çš„å®ç°ï¼ŒåŒ…æ‹¬ï¼š
1. æ—‹è½¬é€»è¾‘çš„æ­£ç¡®æ€§
2. è¾¹ç•Œæ¡†è®¡ç®—çš„å‡†ç¡®æ€§
3. ç¼“å­˜ç®¡ç†çš„åˆç†æ€§
4. ä»£ç çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§
5. ç±»å‹å®‰å…¨æ€§
6. æ€§èƒ½ä¼˜åŒ–
7. è¾¹ç•Œæƒ…å†µå¤„ç†

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. æ—‹è½¬é€»è¾‘
- âœ… `TransformOperations.rotateAction()` æ­£ç¡®å¤„ç†å›¾ç‰‡æ—‹è½¬
- âœ… åªæ›´æ–° `rotation` å±æ€§ï¼Œä¸æ›´æ–° `points`
- âœ… è§’åº¦å•ä½æ­£ç¡®è½¬æ¢ï¼ˆå¼§åº¦ â†’ åº¦ï¼‰

### 2. è¾¹ç•Œæ¡†è®¡ç®—
- âœ… `BoundsCalculator.calculateImageBounds()` è€ƒè™‘æ—‹è½¬
- âœ… è®¡ç®—æ—‹è½¬åçš„ AABBï¼ˆAxis-Aligned Bounding Boxï¼‰

### 3. ç»˜åˆ¶æ”¯æŒ
- âœ… `ImageTool.draw()` ä½¿ç”¨ `ctx.rotate()` å®ç°æ—‹è½¬

### 4. çŠ¶æ€ç®¡ç†
- âœ… `hasActionChanges` æ£€æµ‹ `rotation` å˜åŒ–
- âœ… `setSelectedActions` ä¿ç•™ `rotation` å±æ€§
- âœ… `setLayerActions` é‡æ–°ç”Ÿæˆé”šç‚¹å’Œè¾¹ç•Œæ¡†

## âš ï¸ å‘ç°çš„é—®é¢˜

### 1. ç±»å‹å®‰å…¨æ€§é—®é¢˜

**é—®é¢˜**ï¼šå¤šå¤„ä½¿ç”¨ `as any` æ¥è®¿é—®å›¾ç‰‡å±æ€§

**ä½ç½®**ï¼š
- `TransformOperations.rotateAction()`: `const imageAction = action as any;`
- `BoundsCalculator.calculateImageBounds()`: `const imageAction = action as any;`
- `SelectToolCoordinator.hasActionChanges()`: `const beforeImage = before as any;`
- `SelectTool.setSelectedActions()`: `rotation: (action as any).rotation`

**å½±å“**ï¼š
- ç±»å‹ä¸å®‰å…¨ï¼Œå®¹æ˜“å‡ºé”™
- IDE æ— æ³•æä¾›ç±»å‹æç¤ºå’Œæ£€æŸ¥

**å»ºè®®**ï¼šä½¿ç”¨ `ImageAction` ç±»å‹

### 2. è¾¹ç•Œæ¡†è®¡ç®—ç²¾åº¦é—®é¢˜

**é—®é¢˜**ï¼š`calculateImageBounds` ä½¿ç”¨ `rotation === 0` åˆ¤æ–­ï¼Œä¸å¤Ÿç²¾ç¡®

**å½“å‰ä»£ç **ï¼š
```typescript
if (!rotation || rotation === 0) {
  return { x: point.x, y: point.y, width, height };
}
```

**é—®é¢˜**ï¼š
- æµ®ç‚¹æ•°æ¯”è¾ƒå¯èƒ½ä¸å‡†ç¡®
- åº”è¯¥ä½¿ç”¨å®¹å·®æ¯”è¾ƒ

**å»ºè®®**ï¼šä½¿ç”¨ `Math.abs(rotation) < 0.01`

### 3. æ—‹è½¬ä¸­å¿ƒè®¡ç®—é—®é¢˜

**é—®é¢˜**ï¼š`handleRotateDrag` ä½¿ç”¨ `startBounds` çš„ä¸­å¿ƒï¼Œä½†å¯¹äºå›¾ç‰‡åº”è¯¥ä½¿ç”¨å›¾ç‰‡æœ¬èº«çš„ä¸­å¿ƒ

**å½“å‰ä»£ç **ï¼š
```typescript
const centerX = startBounds.x + startBounds.width / 2;
const centerY = startBounds.y + startBounds.height / 2;
```

**é—®é¢˜**ï¼š
- `startBounds` å¯èƒ½æ˜¯æ—‹è½¬åçš„ AABBï¼Œä¸­å¿ƒç‚¹ä¸å‡†ç¡®
- å¯¹äºå›¾ç‰‡ï¼Œåº”è¯¥ä½¿ç”¨ `points[0] + imageWidth/2, imageHeight/2`

**å½±å“**ï¼š
- æ—‹è½¬ä¸­å¿ƒå¯èƒ½ä¸å‡†ç¡®
- å¤šæ¬¡æ—‹è½¬åå¯èƒ½ç´¯ç§¯è¯¯å·®

### 4. è§’åº¦å•ä½ä¸ä¸€è‡´

**é—®é¢˜**ï¼šä¸åŒ action ç±»å‹çš„ `rotation` å±æ€§å•ä½ä¸ä¸€è‡´

**å½“å‰çŠ¶æ€**ï¼š
- `ImageAction.rotation`: åº¦ï¼ˆdegreesï¼‰
- å…¶ä»– action çš„ `rotation`: å¼§åº¦ï¼ˆradiansï¼‰

**å½±å“**ï¼š
- ä»£ç ä¸ä¸€è‡´ï¼Œå®¹æ˜“æ··æ·†
- å¦‚æœå°†æ¥éœ€è¦ç»Ÿä¸€å¤„ç†ï¼Œä¼šæœ‰é—®é¢˜

**å»ºè®®**ï¼šç»Ÿä¸€ä½¿ç”¨åº¦ï¼ˆdegreesï¼‰ï¼Œå› ä¸ºï¼š
- åº¦æ›´ç›´è§‚
- Canvas API ä½¿ç”¨åº¦
- å­˜å‚¨ç©ºé—´ç›¸åŒ

### 5. å¤šé€‰æ—‹è½¬é—®é¢˜

**é—®é¢˜**ï¼š`rotateActions` å¯èƒ½æ²¡æœ‰æ­£ç¡®å¤„ç†å›¾ç‰‡ç±»å‹

**éœ€è¦æ£€æŸ¥**ï¼š`TransformOperations.rotateActions()` æ˜¯å¦æ­£ç¡®å¤„ç†å›¾ç‰‡ç±»å‹

### 6. ç¼“å­˜ç®¡ç†

**é—®é¢˜**ï¼šæ—‹è½¬åè¾¹ç•Œæ¡†å˜åŒ–ï¼Œä½†ç¼“å­˜å¯èƒ½æ²¡æœ‰åŠæ—¶æ¸…é™¤

**å½“å‰å®ç°**ï¼š
- `syncAndRefreshAfterDrag` æ¸…é™¤ç¼“å­˜ âœ…
- `setLayerActions` æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç”Ÿæˆ âœ…

**æ½œåœ¨é—®é¢˜**ï¼š
- æ—‹è½¬è¿‡ç¨‹ä¸­å¯èƒ½ä½¿ç”¨ç¼“å­˜çš„æ—§è¾¹ç•Œæ¡†

## ğŸ”§ ä¼˜åŒ–å»ºè®®

### 1. ç±»å‹å®‰å…¨ä¼˜åŒ–

**å»ºè®®**ï¼šåˆ›å»ºç±»å‹å®ˆå«å‡½æ•°

```typescript
function isImageAction(action: DrawAction): action is ImageAction {
  return action.type === 'image';
}
```

**ä½¿ç”¨**ï¼š
```typescript
if (isImageAction(action)) {
  const currentRotation = action.rotation || 0; // ç±»å‹å®‰å…¨
  // ...
}
```

### 2. è¾¹ç•Œæ¡†è®¡ç®—ä¼˜åŒ–

**å»ºè®®**ï¼šä½¿ç”¨å®¹å·®æ¯”è¾ƒ

```typescript
const ROTATION_TOLERANCE = 0.01; // åº¦

if (!rotation || Math.abs(rotation) < ROTATION_TOLERANCE) {
  return { x: point.x, y: point.y, width, height };
}
```

### 3. æ—‹è½¬ä¸­å¿ƒè®¡ç®—ä¼˜åŒ–

**å»ºè®®**ï¼šå¯¹äºå›¾ç‰‡ï¼Œä½¿ç”¨å›¾ç‰‡æœ¬èº«çš„ä¸­å¿ƒ

```typescript
if (action.type === 'image') {
  const imageAction = action as ImageAction;
  const centerX = imageAction.points[0].x + imageAction.imageWidth / 2;
  const centerY = imageAction.points[0].y + imageAction.imageHeight / 2;
} else {
  // ä½¿ç”¨è¾¹ç•Œæ¡†ä¸­å¿ƒ
  const centerX = startBounds.x + startBounds.width / 2;
  const centerY = startBounds.y + startBounds.height / 2;
}
```

### 4. è§’åº¦å•ä½ç»Ÿä¸€

**å»ºè®®**ï¼šç»Ÿä¸€ä½¿ç”¨åº¦ï¼ˆdegreesï¼‰

**å½±å“èŒƒå›´**ï¼š
- `TransformOperations.rotateAction()` - å…¶ä»–ç±»å‹ä¹Ÿéœ€è¦è½¬æ¢
- `TransformOperations.rotateActions()` - éœ€è¦æ£€æŸ¥
- æ‰€æœ‰ä½¿ç”¨ `rotation` çš„åœ°æ–¹

### 5. æ€§èƒ½ä¼˜åŒ–

**å»ºè®®**ï¼š
- ç¼“å­˜ä¸‰è§’å‡½æ•°è®¡ç®—ç»“æœï¼ˆå¦‚æœæ—‹è½¬è§’åº¦ä¸å˜ï¼‰
- è¾¹ç•Œæ¡†è®¡ç®—å¯ä»¥ç¼“å­˜ï¼ˆä½†éœ€è¦æ­£ç¡®æ¸…é™¤ï¼‰

### 6. ä»£ç ä¸€è‡´æ€§

**å»ºè®®**ï¼š
- ç»Ÿä¸€ä½¿ç”¨ `ImageAction` ç±»å‹
- ç»Ÿä¸€è§’åº¦å•ä½
- ç»Ÿä¸€å®¹å·®å€¼

## ğŸ“Š ä¼˜å…ˆçº§è¯„ä¼°

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
1. âš ï¸ **ç±»å‹å®‰å…¨æ€§**ï¼šä½¿ç”¨ `ImageAction` ç±»å‹ï¼Œé¿å… `as any`
2. âš ï¸ **æ—‹è½¬ä¸­å¿ƒè®¡ç®—**ï¼šå›¾ç‰‡æ—‹è½¬ä¸­å¿ƒåº”è¯¥ä½¿ç”¨å›¾ç‰‡æœ¬èº«çš„ä¸­å¿ƒ

### ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰
3. âš ï¸ **è¾¹ç•Œæ¡†è®¡ç®—ç²¾åº¦**ï¼šä½¿ç”¨å®¹å·®æ¯”è¾ƒ
4. âš ï¸ **è§’åº¦å•ä½ç»Ÿä¸€**ï¼šç»Ÿä¸€ä½¿ç”¨åº¦

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
5. âš ï¸ **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜ä¸‰è§’å‡½æ•°è®¡ç®—ç»“æœ
6. âš ï¸ **ä»£ç ä¸€è‡´æ€§**ï¼šç»Ÿä¸€ä»£ç é£æ ¼

## ğŸ¯ ä¿®å¤è®¡åˆ’

### Phase 1: ç±»å‹å®‰å…¨
- [ ] åˆ›å»º `isImageAction` ç±»å‹å®ˆå«
- [ ] æ›¿æ¢æ‰€æœ‰ `as any` ä¸ºç±»å‹å®ˆå«
- [ ] ç¡®ä¿ç±»å‹å®‰å…¨

### Phase 2: æ—‹è½¬ä¸­å¿ƒä¿®å¤
- [ ] ä¿®å¤ `handleRotateDrag` çš„æ—‹è½¬ä¸­å¿ƒè®¡ç®—
- [ ] ç¡®ä¿å›¾ç‰‡æ—‹è½¬ä¸­å¿ƒå‡†ç¡®

### Phase 3: ç²¾åº¦ä¼˜åŒ–
- [ ] ä½¿ç”¨å®¹å·®æ¯”è¾ƒæ—‹è½¬è§’åº¦
- [ ] ç¡®ä¿è¾¹ç•Œæ¡†è®¡ç®—å‡†ç¡®

### Phase 4: è§’åº¦å•ä½ç»Ÿä¸€
- [ ] ç»Ÿä¸€æ‰€æœ‰ `rotation` å±æ€§ä¸ºåº¦
- [ ] æ›´æ–°ç›¸å…³ä»£ç 

## âœ¨ æ€»ç»“

å›¾ç‰‡æ—‹è½¬åŠŸèƒ½**åŸºæœ¬å®ç°æ­£ç¡®**ï¼Œä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **ç±»å‹å®‰å…¨æ€§**ï¼šéœ€è¦æ”¹è¿›ï¼Œé¿å…ä½¿ç”¨ `as any`
2. **æ—‹è½¬ä¸­å¿ƒ**ï¼šå›¾ç‰‡æ—‹è½¬ä¸­å¿ƒè®¡ç®—å¯èƒ½ä¸å‡†ç¡®
3. **ç²¾åº¦**ï¼šè¾¹ç•Œæ¡†è®¡ç®—å¯ä»¥ä½¿ç”¨æ›´ç²¾ç¡®çš„æ¯”è¾ƒ
4. **ä¸€è‡´æ€§**ï¼šè§’åº¦å•ä½éœ€è¦ç»Ÿä¸€

**å»ºè®®ä¼˜å…ˆä¿®å¤**ï¼š
- ç±»å‹å®‰å…¨æ€§ï¼ˆæé«˜ä»£ç è´¨é‡ï¼‰
- æ—‹è½¬ä¸­å¿ƒè®¡ç®—ï¼ˆç¡®ä¿åŠŸèƒ½æ­£ç¡®ï¼‰

å…¶ä»–é—®é¢˜å¯ä»¥é€æ­¥ä¼˜åŒ–ã€‚

