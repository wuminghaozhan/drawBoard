# DrawBoard æ€§èƒ½ä¼˜åŒ–æ¶æ„å›¾

## å¤šå±‚æ¬¡æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

è¿™ä¸ªå›¾è¡¨å±•ç¤ºäº† DrawBoard çš„å¤šå±‚æ¬¡æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å’ŒæŠ€æœ¯å®ç°ï¼Œä»æ¸²æŸ“å¼•æ“åˆ°ç”¨æˆ·äº¤äº’çš„å…¨é¢ä¼˜åŒ–ã€‚

```mermaid
graph TB
    subgraph "ç”¨æˆ·äº¤äº’å±‚ (User Interaction)"
        UI1[äº‹ä»¶èŠ‚æµ<br/>16msé—´éš”]
        UI2[è§¦æ‘¸ä¼˜åŒ–<br/>é˜²æŠ–å¤„ç†]
        UI3[é”®ç›˜å¿«æ·é”®<br/>å³æ—¶å“åº”]
    end
    
    subgraph "åº”ç”¨é€»è¾‘å±‚ (Application Logic)"
        AL1[æ‡’åŠ è½½<br/>å·¥å…·æŒ‰éœ€åˆ›å»º]
        AL2[çŠ¶æ€ç®¡ç†<br/>æ‰¹é‡æ›´æ–°]
        AL3[å¤„ç†å™¨æ¨¡å¼<br/>èŒè´£åˆ†ç¦»]
        AL4[å•ä¾‹ç®¡ç†<br/>é¿å…é‡å¤å®ä¾‹]
    end
    
    subgraph "æ¸²æŸ“ä¼˜åŒ–å±‚ (Rendering Optimization)"
        RO1[å¤šå±‚Canvas<br/>åˆ†ç¦»æ¸²æŸ“]
        RO2[é¢„æ¸²æŸ“ç¼“å­˜<br/>æ™ºèƒ½ç¼“å­˜]
        RO3[é‡ç»˜åˆå¹¶<br/>æ‰¹é‡é‡ç»˜]
        RO4[å¤æ‚åº¦ç®¡ç†<br/>è‡ªé€‚åº”æ¨¡å¼]
    end
    
    subgraph "å†…å­˜ç®¡ç†å±‚ (Memory Management)"
        MM1[è½»é‡çº§èµ„æºç®¡ç†<br/>è‡ªåŠ¨æ¸…ç†]
        MM2[å†…å­˜ç›‘æ§<br/>æ³„æ¼æ£€æµ‹]
        MM3[ç¼“å­˜ç­–ç•¥<br/>LRUæ·˜æ±°]
        MM4[åƒåœ¾å›æ”¶<br/>åŠæ—¶é‡Šæ”¾]
    end
    
    subgraph "åº•å±‚æ¸²æŸ“å¼•æ“ (Rendering Engine)"
        RE1[CanvasEngine<br/>ä¸‰å±‚æ¶æ„]
        RE2[äº¤äº’å±‚<br/>z-index: 2]
        RE3[ç»˜åˆ¶å±‚<br/>z-index: 1]
        RE4[èƒŒæ™¯å±‚<br/>z-index: 0]
    end
    
    UI1 --> AL1
    UI2 --> AL1
    UI3 --> AL1
    
    AL1 --> RO1
    AL2 --> RO2
    AL3 --> RO3
    AL4 --> RO4
    
    RO1 --> MM1
    RO2 --> MM2
    RO3 --> MM3
    RO4 --> MM4
    
    MM1 --> RE1
    MM2 --> RE1
    MM3 --> RE1
    MM4 --> RE1
    
    RE1 --> RE2
    RE1 --> RE3
    RE1 --> RE4
    
    style UI1 fill:#e3f2fd
    style AL1 fill:#f3e5f5
    style RO1 fill:#e8f5e8
    style MM1 fill:#fff3e0
    style RE1 fill:#fce4ec
```

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥è¯¦è§£

### ğŸ¯ ç”¨æˆ·äº¤äº’å±‚ä¼˜åŒ–

#### 1. **äº‹ä»¶èŠ‚æµæœºåˆ¶**
```typescript
// é¼ æ ‡ç§»åŠ¨äº‹ä»¶èŠ‚æµåˆ°16ms (60fps)
private mouseMoveThrottle = new Throttle(16);

// è§¦æ‘¸äº‹ä»¶é˜²æŠ–å¤„ç†
private touchDebounce = new Debounce(50);
```

#### 2. **è§¦æ‘¸ä¼˜åŒ–**
- **é˜²æŠ–å¤„ç†**: é¿å…è§¦æ‘¸äº‹ä»¶çš„é¢‘ç¹è§¦å‘
- **åæ ‡ä¼˜åŒ–**: ç²¾ç¡®çš„è§¦æ‘¸åæ ‡è®¡ç®—
- **æ‰‹åŠ¿è¯†åˆ«**: æ™ºèƒ½çš„æ‰‹åŠ¿æ£€æµ‹

#### 3. **é”®ç›˜å¿«æ·é”®**
- **å³æ—¶å“åº”**: é”®ç›˜äº‹ä»¶æ— å»¶è¿Ÿå¤„ç†
- **ç»„åˆé”®æ”¯æŒ**: æ”¯æŒå¤æ‚çš„å¿«æ·é”®ç»„åˆ
- **å†²çªæ£€æµ‹**: é¿å…å¿«æ·é”®å†²çª

### âš¡ åº”ç”¨é€»è¾‘å±‚ä¼˜åŒ–

#### 1. **æ‡’åŠ è½½æœºåˆ¶**
```typescript
class ToolFactory {
  private tools: Map<ToolType, DrawTool> = new Map();
  
  async createTool(type: ToolType): Promise<DrawTool> {
    if (this.tools.has(type)) {
      return this.tools.get(type)!; // ä»ç¼“å­˜è¿”å›
    }
    
    const tool = await this.loadTool(type); // åŠ¨æ€åŠ è½½
    this.tools.set(type, tool); // ç¼“å­˜å·¥å…·
    return tool;
  }
}
```

#### 2. **çŠ¶æ€ç®¡ç†ä¼˜åŒ–**
- **æ‰¹é‡æ›´æ–°**: é¿å…é¢‘ç¹çš„çŠ¶æ€æ›´æ–°
- **å¢é‡æ›´æ–°**: åªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†
- **çŠ¶æ€ç¼“å­˜**: ç¼“å­˜è®¡ç®—ç»“æœ

#### 3. **å¤„ç†å™¨æ¨¡å¼**
- **èŒè´£åˆ†ç¦»**: é™ä½ç»„ä»¶é—´è€¦åˆ
- **å¹¶è¡Œå¤„ç†**: æ”¯æŒå¹¶å‘æ“ä½œ
- **é”™è¯¯éš”ç¦»**: å•ä¸ªå¤„ç†å™¨é”™è¯¯ä¸å½±å“æ•´ä½“

### ğŸ¨ æ¸²æŸ“ä¼˜åŒ–å±‚

#### 1. **å¤šå±‚Canvasæ¶æ„**
```typescript
// ä¸‰å±‚Canvasåˆ†ç¦»
äº¤äº’å±‚ (z-index: 2) - å®æ—¶äº¤äº’åé¦ˆ
ç»˜åˆ¶å±‚ (z-index: 1) - æœ€ç»ˆç»˜åˆ¶ç»“æœ  
èƒŒæ™¯å±‚ (z-index: 0) - èƒŒæ™¯å’Œç½‘æ ¼
```

#### 2. **é¢„æ¸²æŸ“ç¼“å­˜ç³»ç»Ÿ**
```typescript
class PerformanceManager {
  private cacheMap: Map<string, PreRenderedCache> = new Map();
  
  shouldCache(action: DrawAction): boolean {
    // æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦ç¼“å­˜
    return action.complexity > this.config.complexityThreshold;
  }
  
  createCache(action: DrawAction, canvas: HTMLCanvasElement): PreRenderedCache {
    // åˆ›å»ºé¢„æ¸²æŸ“ç¼“å­˜
    const cache = this.renderToCache(action, canvas);
    this.cacheMap.set(action.id, cache);
    return cache;
  }
}
```

#### 3. **é‡ç»˜åˆå¹¶æœºåˆ¶**
```typescript
class DrawingHandler {
  private redrawScheduled: boolean = false;
  
  scheduleRedraw(): void {
    if (!this.redrawScheduled) {
      this.redrawScheduled = true;
      requestAnimationFrame(() => {
        this.performRedraw();
        this.redrawScheduled = false;
      });
    }
  }
}
```

#### 4. **å¤æ‚åº¦ç®¡ç†ç³»ç»Ÿ**
```typescript
class ComplexityManager {
  calculateComplexity(action: DrawAction): number {
    // è®¡ç®—ç»˜åˆ¶åŠ¨ä½œçš„å¤æ‚åº¦
    const pointCount = action.points.length;
    const toolComplexity = this.getToolComplexity(action.toolType);
    return pointCount * toolComplexity;
  }
  
  shouldOptimize(complexity: number): boolean {
    return complexity > this.config.optimizationThreshold;
  }
}
```

### ğŸ’¾ å†…å­˜ç®¡ç†å±‚

#### 1. **è½»é‡çº§èµ„æºç®¡ç†**
```typescript
class LightweightResourceManager {
  private resources: Map<string, DestroyableResource> = new Map();
  
  register(name: string, resource: DestroyableResource): void {
    this.resources.set(name, resource);
  }
  
  destroy(name: string): boolean {
    const resource = this.resources.get(name);
    if (resource) {
      resource.destroy();
      this.resources.delete(name);
      return true;
    }
    return false;
  }
  
  checkResourceLeaks(): { leaked: string[]; total: number } {
    // æ£€æµ‹èµ„æºæ³„æ¼
    const leaked = Array.from(this.resources.keys());
    return { leaked, total: leaked.length };
  }
}
```

#### 2. **å†…å­˜ç›‘æ§ç³»ç»Ÿ**
```typescript
class PerformanceManager {
  getMemoryStats(): MemoryStats {
    return {
      totalMemory: performance.memory?.usedJSHeapSize || 0,
      cacheHitRate: this.calculateCacheHitRate(),
      underMemoryPressure: this.isUnderMemoryPressure(),
      cacheSize: this.cacheMap.size
    };
  }
  
  private isUnderMemoryPressure(): boolean {
    const memoryUsage = performance.memory?.usedJSHeapSize || 0;
    const memoryLimit = performance.memory?.jsHeapSizeLimit || 0;
    return memoryUsage > memoryLimit * 0.8; // 80%é˜ˆå€¼
  }
}
```

#### 3. **ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**
- **LRUæ·˜æ±°**: æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜ä¼˜å…ˆæ·˜æ±°
- **å¤§å°é™åˆ¶**: ç¼“å­˜æ€»å¤§å°é™åˆ¶
- **è¿‡æœŸæ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
- **ä¼˜å…ˆçº§ç®¡ç†**: é‡è¦å†…å®¹ä¼˜å…ˆç¼“å­˜

### ğŸš€ æ€§èƒ½ç›‘æ§å’Œè°ƒä¼˜

#### 1. **å®æ—¶æ€§èƒ½ç›‘æ§**
```typescript
class PerformanceManager {
  private performanceMetrics = {
    frameRate: 0,
    drawCalls: 0,
    cacheHits: 0,
    cacheMisses: 0,
    memoryUsage: 0
  };
  
  updateMetrics(): void {
    // å®æ—¶æ›´æ–°æ€§èƒ½æŒ‡æ ‡
    this.performanceMetrics.frameRate = this.calculateFrameRate();
    this.performanceMetrics.memoryUsage = this.getCurrentMemoryUsage();
  }
}
```

#### 2. **è‡ªé€‚åº”æ€§èƒ½æ¨¡å¼**
```typescript
enum PerformanceMode {
  HIGH_QUALITY = 'high_quality',
  BALANCED = 'balanced',
  PERFORMANCE = 'performance'
}

class PerformanceManager {
  setPerformanceMode(mode: PerformanceMode): void {
    this.currentMode = mode;
    this.adjustRenderingQuality();
    this.updateCacheStrategy();
  }
}
```

#### 3. **æ€§èƒ½æŠ¥å‘Šç³»ç»Ÿ**
- **å®æ—¶ç›‘æ§**: æŒç»­ç›‘æ§æ€§èƒ½æŒ‡æ ‡
- **æ€§èƒ½æŠ¥å‘Š**: ç”Ÿæˆè¯¦ç»†çš„æ€§èƒ½æŠ¥å‘Š
- **ä¼˜åŒ–å»ºè®®**: æä¾›æ€§èƒ½ä¼˜åŒ–å»ºè®®
- **è‡ªåŠ¨è°ƒä¼˜**: æ ¹æ®æ€§èƒ½æŒ‡æ ‡è‡ªåŠ¨è°ƒæ•´

### ğŸ“Š æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

#### **æ¸²æŸ“æ€§èƒ½æå‡**
- **å¸§ç‡**: ç¨³å®š60fps
- **å“åº”æ—¶é—´**: <16ms
- **å†…å­˜ä½¿ç”¨**: å‡å°‘30%
- **ç¼“å­˜å‘½ä¸­ç‡**: >80%

#### **ç”¨æˆ·ä½“éªŒæ”¹å–„**
- **æµç•…ç»˜åˆ¶**: æ— å¡é¡¿çš„ç»˜åˆ¶ä½“éªŒ
- **å¿«é€Ÿå“åº”**: å³æ—¶çš„ç”¨æˆ·åé¦ˆ
- **ç¨³å®šè¿è¡Œ**: é•¿æ—¶é—´è¿è¡Œæ— æ€§èƒ½è¡°å‡
- **èµ„æºèŠ‚çº¦**: æ›´ä½çš„å†…å­˜å’ŒCPUå ç”¨ 