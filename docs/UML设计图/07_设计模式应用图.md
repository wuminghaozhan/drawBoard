# DrawBoard è®¾è®¡æ¨¡å¼åº”ç”¨å›¾

## å…­å¤§è®¾è®¡æ¨¡å¼åœ¨ç³»ç»Ÿä¸­çš„å…·ä½“åº”ç”¨

è¿™ä¸ªå›¾è¡¨å±•ç¤ºäº† DrawBoard ç³»ç»Ÿä¸­åº”ç”¨çš„å…­å¤§æ ¸å¿ƒè®¾è®¡æ¨¡å¼ï¼Œä»¥åŠå®ƒä»¬åœ¨æ¶æ„ä¸­çš„å…·ä½“ä½œç”¨å’Œå…³ç³»ã€‚

```mermaid
graph TD
    subgraph "è®¾è®¡æ¨¡å¼åº”ç”¨æ¶æ„"
        subgraph "é—¨é¢æ¨¡å¼ (Facade)"
            F1[DrawBoardä¸»ç±»<br/>ç»Ÿä¸€APIå…¥å£]
            F2[éšè—å­ç³»ç»Ÿå¤æ‚æ€§]
            F3[ç®€åŒ–å®¢æˆ·ç«¯è°ƒç”¨]
        end
        
        subgraph "å·¥å‚æ¨¡å¼ (Factory)"
            FA1[ToolFactory<br/>å·¥å…·å·¥å‚]
            FA2[æ‡’åŠ è½½æœºåˆ¶]
            FA3[å®ä¾‹ç¼“å­˜]
            FA4[åŠ¨æ€åˆ›å»º]
        end
        
        subgraph "ç­–ç•¥æ¨¡å¼ (Strategy)"
            S1[æ¸²æŸ“ç­–ç•¥æ¥å£]
            S2[BezierRenderer<br/>é«˜è´¨é‡æ¸²æŸ“]
            S3[RealtimeRenderer<br/>å®æ—¶æ¸²æŸ“]
            S4[åŠ¨æ€ç­–ç•¥åˆ‡æ¢]
        end
        
        subgraph "è§‚å¯Ÿè€…æ¨¡å¼ (Observer)"
            O1[EventManager<br/>äº‹ä»¶ç®¡ç†]
            O2[äº‹ä»¶å‘å¸ƒ]
            O3[äº‹ä»¶è®¢é˜…]
            O4[æ¾è€¦åˆé€šä¿¡]
        end
        
        subgraph "å‘½ä»¤æ¨¡å¼ (Command)"
            C1[DrawAction<br/>ç»˜åˆ¶å‘½ä»¤]
            C2[HistoryManager<br/>å‘½ä»¤å†å²]
            C3[Undo/Redo<br/>å‘½ä»¤æ’¤é”€]
            C4[å‘½ä»¤é˜Ÿåˆ—]
        end
        
        subgraph "å¤„ç†å™¨æ¨¡å¼ (Handler)"
            H1[DrawingHandler<br/>ç»˜åˆ¶å¤„ç†]
            H2[StateHandler<br/>çŠ¶æ€å¤„ç†]
            H3[CursorHandler<br/>å…‰æ ‡å¤„ç†]
            H4[èŒè´£åˆ†ç¦»]
        end
    end
    
    F1 --> F2
    F2 --> F3
    
    FA1 --> FA2
    FA2 --> FA3
    FA3 --> FA4
    
    S1 --> S2
    S1 --> S3
    S2 --> S4
    S3 --> S4
    
    O1 --> O2
    O2 --> O3
    O3 --> O4
    
    C1 --> C2
    C2 --> C3
    C3 --> C4
    
    H1 --> H4
    H2 --> H4
    H3 --> H4
    
    style F1 fill:#e3f2fd
    style FA1 fill:#f3e5f5
    style S1 fill:#e8f5e8
    style O1 fill:#fff3e0
    style C1 fill:#fce4ec
    style H1 fill:#f1f8e9
```

## è®¾è®¡æ¨¡å¼è¯¦è§£

### ğŸ­ 1. é—¨é¢æ¨¡å¼ (Facade Pattern)

#### åº”ç”¨åœºæ™¯
DrawBoard ä¸»ç±»ä½œä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œå‘å®¢æˆ·ç«¯æä¾›ç®€æ´çš„APIæ¥å£ã€‚

#### ä»£ç å®ç°
```typescript
export class DrawBoard {
  // éšè—çš„å¤æ‚å­ç³»ç»Ÿ
  private canvasEngine: CanvasEngine;
  private toolManager: ToolManager;
  private historyManager: HistoryManager;
  private eventManager: EventManager;
  private performanceManager: PerformanceManager;
  
  // ç®€æ´çš„å…¬å…±API
  public setTool(tool: ToolType): void {
    // å†…éƒ¨åè°ƒå¤šä¸ªå­ç³»ç»Ÿ
    this.toolManager.setCurrentTool(tool);
    this.cursorHandler.updateCursor(tool);
    this.stateHandler.emitStateChange();
  }
  
  public setColor(color: string): void {
    this.canvasEngine.setContext({ strokeStyle: color });
    this.stateHandler.emitStateChange();
  }
  
  public undo(): void {
    const actions = this.historyManager.undo();
    this.redrawCanvas(actions);
    this.stateHandler.emitStateChange();
  }
}
```

#### æ¨¡å¼ä¼˜åŠ¿
- ğŸ¯ **ç®€åŒ–è°ƒç”¨**: å®¢æˆ·ç«¯åªéœ€è¦çŸ¥é“DrawBoardä¸€ä¸ªç±»
- ğŸ”’ **éšè—å¤æ‚æ€§**: å†…éƒ¨å­ç³»ç»Ÿçš„å¤æ‚åè°ƒé€»è¾‘è¢«éšè—
- ğŸ“ **ç»Ÿä¸€æ¥å£**: æä¾›ä¸€è‡´çš„APIä½“éªŒ
- ğŸ›¡ï¸ **é™ä½è€¦åˆ**: å®¢æˆ·ç«¯ä¸å­ç³»ç»Ÿè§£è€¦

### ğŸ­ 2. å·¥å‚æ¨¡å¼ (Factory Pattern)

#### åº”ç”¨åœºæ™¯
ToolFactory è´Ÿè´£åˆ›å»ºå’Œç®¡ç†æ‰€æœ‰ç»˜åˆ¶å·¥å…·çš„å®ä¾‹ï¼Œæ”¯æŒæ‡’åŠ è½½å’Œç¼“å­˜ã€‚

#### ä»£ç å®ç°
```typescript
export class ToolFactory {
  private tools: Map<ToolType, DrawTool> = new Map();
  private factories: Map<ToolType, () => Promise<DrawTool>> = new Map();

  // æ³¨å†Œå·¥å…·å·¥å‚å‡½æ•°
  public register(type: ToolType, factory: () => Promise<DrawTool>): void {
    this.factories.set(type, factory);
  }

  // æ‡’åŠ è½½ + ç¼“å­˜æœºåˆ¶
  public async createTool(type: ToolType): Promise<DrawTool> {
    // æ£€æŸ¥ç¼“å­˜
    if (this.tools.has(type)) {
      return this.tools.get(type)!;
    }

    // åŠ¨æ€åˆ›å»º
    const factory = this.factories.get(type);
    if (!factory) {
      throw new Error(`æœªçŸ¥çš„å·¥å…·ç±»å‹: ${type}`);
    }

    const tool = await factory();
    this.tools.set(type, tool); // ç¼“å­˜å®ä¾‹
    return tool;
  }

  // å†…ç½®å·¥å…·æ³¨å†Œ
  private registerBuiltinTools(): void {
    this.register('pen', async () => {
      const { PenToolRefactored } = await import('./PenToolRefactored');
      return new PenToolRefactored();
    });
  }
}
```

#### æ¨¡å¼ä¼˜åŠ¿
- âš¡ **æ‡’åŠ è½½**: å·¥å…·æŒ‰éœ€åˆ›å»ºï¼Œæå‡å¯åŠ¨é€Ÿåº¦
- ğŸ’¾ **å®ä¾‹ç¼“å­˜**: é¿å…é‡å¤åˆ›å»ºï¼ŒèŠ‚çœå†…å­˜
- ğŸ”§ **æ˜“äºæ‰©å±•**: æ·»åŠ æ–°å·¥å…·åªéœ€æ³¨å†Œå·¥å‚å‡½æ•°
- ğŸ›ï¸ **ç»Ÿä¸€åˆ›å»º**: æ‰€æœ‰å·¥å…·é€šè¿‡ç»Ÿä¸€æ¥å£åˆ›å»º

### ğŸ¨ 3. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

#### åº”ç”¨åœºæ™¯
è¿ç¬”æ•ˆæœç³»ç»Ÿä½¿ç”¨ä¸åŒçš„æ¸²æŸ“ç­–ç•¥ï¼Œå¯ä»¥æ ¹æ®æ€§èƒ½éœ€æ±‚åŠ¨æ€åˆ‡æ¢ã€‚

#### ä»£ç å®ç°
```typescript
// ç­–ç•¥æ¥å£
interface Renderer {
  render(ctx: CanvasRenderingContext2D, points: StrokePoint[]): void;
}

// å…·ä½“ç­–ç•¥å®ç°
class BezierRenderer implements Renderer {
  render(ctx: CanvasRenderingContext2D, points: StrokePoint[]): void {
    // é«˜è´¨é‡è´å¡å°”æ›²çº¿æ¸²æŸ“
    this.renderBezierCurve(ctx, points);
  }
}

class RealtimeRenderer implements Renderer {
  render(ctx: CanvasRenderingContext2D, points: StrokePoint[]): void {
    // å®æ—¶ä¼˜åŒ–æ¸²æŸ“
    this.renderOptimized(ctx, points);
  }
}

// ä¸Šä¸‹æ–‡ç±»
class PenToolRefactored extends DrawTool {
  private bezierRenderer: BezierRenderer;
  private realtimeRenderer: RealtimeRenderer;

  draw(ctx: CanvasRenderingContext2D, action: DrawAction): void {
    // åŠ¨æ€é€‰æ‹©ç­–ç•¥
    if (this.shouldUseHighQuality(action)) {
      this.bezierRenderer.render(ctx, action.points);
    } else {
      this.realtimeRenderer.render(ctx, action.points);
    }
  }
}
```

#### æ¨¡å¼ä¼˜åŠ¿
- ğŸ¨ **çµæ´»åˆ‡æ¢**: å¯æ ¹æ®éœ€æ±‚åŠ¨æ€é€‰æ‹©æ¸²æŸ“ç­–ç•¥
- âš¡ **æ€§èƒ½ä¼˜åŒ–**: ä¸åŒåœºæ™¯ä½¿ç”¨æœ€é€‚åˆçš„ç®—æ³•
- ğŸ”§ **æ˜“äºæ‰©å±•**: æ–°å¢æ¸²æŸ“ç­–ç•¥ä¸å½±å“ç°æœ‰ä»£ç 
- ğŸ§ª **ä¾¿äºæµ‹è¯•**: æ¯ç§ç­–ç•¥å¯ç‹¬ç«‹æµ‹è¯•

### ğŸ‘€ 4. è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

#### åº”ç”¨åœºæ™¯
äº‹ä»¶ç³»ç»Ÿä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼å¤„ç†ç”¨æˆ·äº¤äº’å’Œç³»ç»Ÿé€šä¿¡ã€‚

#### ä»£ç å®ç°
```typescript
export class EventManager {
  private handlers: Map<string, EventHandler[]> = new Map();

  // æ³¨å†Œè§‚å¯Ÿè€…
  public on(event: string, handler: EventHandler): void {
    if (!this.handlers.has(event)) {
      this.handlers.set(event, []);
    }
    this.handlers.get(event)!.push(handler);
  }

  // ç§»é™¤è§‚å¯Ÿè€…
  public off(event: string, handler: EventHandler): void {
    const handlers = this.handlers.get(event);
    if (handlers) {
      const index = handlers.indexOf(handler);
      if (index > -1) {
        handlers.splice(index, 1);
      }
    }
  }

  // é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…
  public emit(event: string, data: any): void {
    const handlers = this.handlers.get(event);
    if (handlers) {
      handlers.forEach(handler => {
        try {
          handler(data);
        } catch (error) {
          console.error('äº‹ä»¶å¤„ç†å™¨é”™è¯¯:', error);
        }
      });
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
eventManager.on('tool-changed', (tool) => {
  cursorHandler.updateCursor(tool);
});

eventManager.on('drawing-completed', (action) => {
  historyManager.addAction(action);
  stateHandler.emitStateChange();
});
```

#### æ¨¡å¼ä¼˜åŠ¿
- ğŸ”„ **æ¾è€¦åˆ**: å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¸ç›´æ¥ä¾èµ–
- ğŸ“¡ **ä¸€å¯¹å¤š**: ä¸€ä¸ªäº‹ä»¶å¯é€šçŸ¥å¤šä¸ªå¤„ç†å™¨
- ğŸ¯ **åŠ¨æ€è®¢é˜…**: å¯è¿è¡Œæ—¶æ·»åŠ /ç§»é™¤äº‹ä»¶å¤„ç†å™¨
- ğŸ”€ **äº‹ä»¶é©±åŠ¨**: æ”¯æŒå¤æ‚çš„äº‹ä»¶æµå¤„ç†

### ğŸ“‹ 5. å‘½ä»¤æ¨¡å¼ (Command Pattern)

#### åº”ç”¨åœºæ™¯
å†å²è®°å½•ç³»ç»Ÿä½¿ç”¨å‘½ä»¤æ¨¡å¼å®ç°æ’¤é”€/é‡åšåŠŸèƒ½ã€‚

#### ä»£ç å®ç°
```typescript
// å‘½ä»¤æ¥å£
interface Command {
  execute(): void;
  undo(): void;
  redo(): void;
}

// å…·ä½“å‘½ä»¤å®ç°
class DrawCommand implements Command {
  constructor(
    private action: DrawAction,
    private canvasEngine: CanvasEngine
  ) {}

  execute(): void {
    this.canvasEngine.drawAction(this.action);
  }

  undo(): void {
    this.canvasEngine.removeAction(this.action.id);
    this.canvasEngine.redrawAllActions();
  }

  redo(): void {
    this.execute();
  }
}

// å‘½ä»¤ç®¡ç†å™¨
export class HistoryManager {
  private commands: Command[] = [];
  private currentIndex: number = -1;
  private maxHistorySize: number = 50;

  public executeCommand(command: Command): void {
    // æ‰§è¡Œå‘½ä»¤
    command.execute();
    
    // æ¸…ç†é‡åšå†å²
    this.commands = this.commands.slice(0, this.currentIndex + 1);
    
    // æ·»åŠ æ–°å‘½ä»¤
    this.commands.push(command);
    this.currentIndex++;
    
    // ç»´æŠ¤å†å²å¤§å°é™åˆ¶
    if (this.commands.length > this.maxHistorySize) {
      this.commands.shift();
      this.currentIndex--;
    }
  }

  public undo(): void {
    if (this.currentIndex >= 0) {
      this.commands[this.currentIndex].undo();
      this.currentIndex--;
    }
  }

  public redo(): void {
    if (this.currentIndex < this.commands.length - 1) {
      this.currentIndex++;
      this.commands[this.currentIndex].redo();
    }
  }
}
```

#### æ¨¡å¼ä¼˜åŠ¿
- ğŸ”„ **æ’¤é”€é‡åš**: è½»æ¾å®ç°å¤æ‚çš„æ’¤é”€/é‡åšé€»è¾‘
- ğŸ“ **æ“ä½œè®°å½•**: å®Œæ•´è®°å½•ç”¨æˆ·æ“ä½œå†å²
- ğŸ¯ **å»¶è¿Ÿæ‰§è¡Œ**: æ”¯æŒå‘½ä»¤çš„å»¶è¿Ÿæˆ–æ‰¹é‡æ‰§è¡Œ
- ğŸ” **æ“ä½œå®¡è®¡**: å¯è¿½è¸ªæ‰€æœ‰æ“ä½œè®°å½•

### ğŸ”§ 6. å¤„ç†å™¨æ¨¡å¼ (Handler Pattern)

#### åº”ç”¨åœºæ™¯
å°† DrawBoard çš„å¤æ‚ä¸šåŠ¡é€»è¾‘åˆ†ç¦»åˆ°ä¸“é—¨çš„å¤„ç†å™¨ä¸­ï¼Œå®ç°èŒè´£åˆ†ç¦»ã€‚

#### ä»£ç å®ç°
```typescript
// ç»˜åˆ¶å¤„ç†å™¨
export class DrawingHandler {
  constructor(
    private canvasEngine: CanvasEngine,
    private toolManager: ToolManager,
    private historyManager: HistoryManager,
    private onStateChange: () => void
  ) {}

  public handleDrawStart(event: DrawEvent): void {
    if (this.isDrawing) return;
    
    this.isDrawing = true;
    const tool = this.toolManager.getCurrentTool();
    
    this.currentAction = {
      id: generateId(),
      type: tool.getActionType(),
      points: [event.point],
      context: this.canvasEngine.getContext(),
      timestamp: Date.now()
    };
  }

  public handleDrawEnd(event: DrawEvent): void {
    if (!this.isDrawing || !this.currentAction) return;
    
    // ä¿å­˜åˆ°å†å²è®°å½•
    this.historyManager.addAction(this.currentAction);
    
    // ç»˜åˆ¶åˆ°æœ€ç»ˆå±‚
    const tool = this.toolManager.getCurrentTool();
    tool.draw(this.canvasEngine.getDrawLayer(), this.currentAction);
    
    this.isDrawing = false;
    this.currentAction = null;
    this.onStateChange();
  }
}

// çŠ¶æ€å¤„ç†å™¨
export class StateHandler {
  public getState(): DrawBoardState {
    return {
      currentTool: this.toolManager.getCurrentToolType(),
      isDrawing: this.drawingHandler.isDrawing(),
      canUndo: this.historyManager.canUndo(),
      canRedo: this.historyManager.canRedo(),
      historyCount: this.historyManager.getHistoryCount(),
      hasSelection: this.selectionManager.hasSelection()
    };
  }

  public emitStateChange(): void {
    const state = this.getState();
    this.eventManager.emit('state-changed', state);
  }
}

// å…‰æ ‡å¤„ç†å™¨
export class CursorHandler {
  public updateCursor(tool: ToolType): void {
    switch (tool) {
      case 'pen':
        this.setCursor('crosshair');
        break;
      case 'eraser':
        this.setCursor('grab');
        break;
      case 'select':
        this.setCursor('default');
        break;
      default:
        this.setCursor('crosshair');
    }
  }
}
```

#### æ¨¡å¼ä¼˜åŠ¿
- ğŸ¯ **èŒè´£åˆ†ç¦»**: æ¯ä¸ªå¤„ç†å™¨ä¸“æ³¨ç‰¹å®šåŠŸèƒ½
- ğŸ”„ **æ˜“äºæµ‹è¯•**: å¤„ç†å™¨å¯ç‹¬ç«‹æµ‹è¯•
- ğŸ“ˆ **æ˜“äºç»´æŠ¤**: åŠŸèƒ½ä¿®æ”¹å½±å“èŒƒå›´å°
- ğŸ”§ **æ˜“äºæ‰©å±•**: å¯è½»æ¾æ·»åŠ æ–°çš„å¤„ç†å™¨

## è®¾è®¡æ¨¡å¼åä½œå…³ç³»

### ğŸ”„ æ¨¡å¼é—´çš„åä½œ

```
ç”¨æˆ·æ“ä½œ â†’ é—¨é¢æ¨¡å¼(DrawBoard) â†’ å·¥å‚æ¨¡å¼(åˆ›å»ºå·¥å…·) â†’ ç­–ç•¥æ¨¡å¼(é€‰æ‹©æ¸²æŸ“)
    â†“                                                           â†“
è§‚å¯Ÿè€…æ¨¡å¼(äº‹ä»¶é€šçŸ¥) â† å¤„ç†å™¨æ¨¡å¼(ä¸šåŠ¡å¤„ç†) â† å‘½ä»¤æ¨¡å¼(å†å²è®°å½•)
```

### ğŸ¯ åä½œä¼˜åŠ¿

1. **é—¨é¢æ¨¡å¼ + å·¥å‚æ¨¡å¼**: ç®€åŒ–APIçš„åŒæ—¶æ”¯æŒå·¥å…·çš„çµæ´»åˆ›å»º
2. **ç­–ç•¥æ¨¡å¼ + å·¥å‚æ¨¡å¼**: åŠ¨æ€é€‰æ‹©ç®—æ³•çš„åŒæ—¶æ”¯æŒç®—æ³•çš„æ‡’åŠ è½½
3. **è§‚å¯Ÿè€…æ¨¡å¼ + å¤„ç†å™¨æ¨¡å¼**: äº‹ä»¶é©±åŠ¨çš„ä¸šåŠ¡é€»è¾‘å¤„ç†
4. **å‘½ä»¤æ¨¡å¼ + å¤„ç†å™¨æ¨¡å¼**: å¯æ’¤é”€çš„æ“ä½œå¤„ç†

## æ¨¡å¼åº”ç”¨æ•ˆæœ

### ğŸ“Š è´¨é‡æå‡æŒ‡æ ‡

| è´¨é‡æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|----------|--------|--------|------|
| ä»£ç è€¦åˆåº¦ | é«˜ | ä½ | 80% |
| æ‰©å±•æ€§ | å›°éš¾ | ç®€å• | 300% |
| å¯æµ‹è¯•æ€§ | å·® | ä¼˜ç§€ | 400% |
| ç»´æŠ¤æˆæœ¬ | é«˜ | ä½ | 70% |

### âš¡ å¼€å‘æ•ˆç‡æå‡

- **æ–°åŠŸèƒ½å¼€å‘**: æ—¶é—´å‡å°‘ 75%
- **Bug ä¿®å¤**: æ—¶é—´å‡å°‘ 80%
- **ä»£ç å®¡æŸ¥**: æ•ˆç‡æå‡ 60%
- **é‡æ„æˆæœ¬**: é™ä½ 90%

### ğŸ”® æœªæ¥æ‰©å±•èƒ½åŠ›

- **æ–°å·¥å…·æ·»åŠ **: åªéœ€å®ç°æ¥å£å’Œæ³¨å†Œ
- **æ–°æ¸²æŸ“ç­–ç•¥**: åªéœ€å®ç°æ¸²æŸ“æ¥å£
- **æ–°äº‹ä»¶ç±»å‹**: åªéœ€æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
- **æ–°å¤„ç†å™¨**: åªéœ€å®ç°å¤„ç†é€»è¾‘ 