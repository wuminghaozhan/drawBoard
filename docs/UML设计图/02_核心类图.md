# DrawBoard æ ¸å¿ƒç±»å›¾

## ç³»ç»Ÿæ ¸å¿ƒç±»ç»“æ„

è¿™ä¸ªç±»å›¾å±•ç¤ºäº† DrawBoard ç³»ç»Ÿä¸­æ ¸å¿ƒç±»çš„ç»“æ„ã€å±æ€§ã€æ–¹æ³•ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚

```mermaid
classDiagram
    class DrawBoard {
        -canvasEngine: CanvasEngine
        -toolManager: ToolManager
        -historyManager: HistoryManager
        -eventManager: EventManager
        -performanceManager: PerformanceManager
        -drawingHandler: DrawingHandler
        -stateHandler: StateHandler
        -cursorHandler: CursorHandler
        +setTool(tool: ToolType): void
        +setColor(color: string): void
        +setLineWidth(width: number): void
        +undo(): void
        +redo(): void
        +exportImage(): string
        +getState(): DrawBoardState
        +destroy(): void
    }
    
    class CanvasEngine {
        -layers: Map~string, CanvasLayer~
        -width: number
        -height: number
        +createLayer(name: string, zIndex: number): void
        +getLayer(name: string): CanvasLayer
        +clear(layerName?: string): void
        +resize(): void
        +setContext(context: DrawContext): void
    }
    
    class ToolManager {
        -currentTool: ToolType
        -currentToolInstance: DrawTool
        -toolFactory: ToolFactory
        +setCurrentTool(type: ToolType): Promise~void~
        +getCurrentTool(): DrawTool
        +getAvailableToolTypes(): ToolType[]
    }
    
    class ToolFactory {
        -tools: Map~ToolType, DrawTool~
        -factories: Map~ToolType, Function~
        +register(type: ToolType, factory: Function): void
        +createTool(type: ToolType): Promise~DrawTool~
        +getAvailableToolTypes(): ToolType[]
    }
    
    class DrawTool {
        <<abstract>>
        +name: string
        +type: string
        +draw(ctx: CanvasRenderingContext2D, action: DrawAction): void*
        +getActionType(): string*
        #setContext(ctx: CanvasRenderingContext2D, context: DrawContext): void
    }
    
    class PenToolRefactored {
        -strokeConfig: StrokeConfig
        -calculator: StrokeCalculator
        -bezierRenderer: BezierRenderer
        -realtimeRenderer: RealtimeRenderer
        +draw(ctx: CanvasRenderingContext2D, action: DrawAction): void
        +setStrokeConfig(config: StrokeConfig): void
        +setPreset(preset: StrokePresetType): void
    }
    
    class StrokeCalculator {
        -config: StrokeConfig
        +calculatePressure(point: StrokePoint): number
        +calculateVelocity(points: StrokePoint[]): number
        +calculateAngle(points: StrokePoint[]): number
        +smoothPoints(points: StrokePoint[]): StrokePoint[]
    }
    
    class BezierRenderer {
        -config: StrokeConfig
        +render(ctx: CanvasRenderingContext2D, points: StrokePoint[]): void
        +renderHighQuality(ctx: CanvasRenderingContext2D, points: StrokePoint[]): void
    }
    
    class EventManager {
        -canvas: HTMLCanvasElement
        -handlers: Map~string, EventHandler[]~
        -mouseMoveThrottle: Throttle
        +on(event: string, handler: EventHandler): void
        +emit(event: string, data: any): void
        +bindEvents(): void
    }
    
    class HistoryManager {
        -actions: DrawAction[]
        -currentIndex: number
        -maxHistorySize: number
        +addAction(action: DrawAction): void
        +undo(): DrawAction[]
        +redo(): DrawAction[]
        +clear(): void
    }
    
    class PerformanceManager {
        -config: PerformanceConfig
        -cacheMap: Map~string, PreRenderedCache~
        +shouldCache(action: DrawAction): boolean
        +createCache(action: DrawAction, canvas: HTMLCanvasElement): PreRenderedCache
        +drawFromCache(ctx: CanvasRenderingContext2D, action: DrawAction): boolean
        +getCurrentMemoryUsage(): number
    }
    
    DrawBoard --> CanvasEngine
    DrawBoard --> ToolManager
    DrawBoard --> EventManager
    DrawBoard --> HistoryManager
    DrawBoard --> PerformanceManager
    
    ToolManager --> ToolFactory
    ToolFactory ..> DrawTool : creates
    DrawTool <|-- PenToolRefactored
    DrawTool <|-- RectTool
    DrawTool <|-- CircleTool
    DrawTool <|-- SelectTool
    
    PenToolRefactored --> StrokeCalculator
    PenToolRefactored --> BezierRenderer
    PenToolRefactored --> RealtimeRenderer
```

## ç±»å…³ç³»è¯´æ˜

### ğŸ¯ æ ¸å¿ƒå…³ç³»

#### ç»„åˆå…³ç³» (Composition)
- **DrawBoard** ç»„åˆäº†æ‰€æœ‰æ ¸å¿ƒç®¡ç†å™¨
- **PenToolRefactored** ç»„åˆäº†è¿ç¬”æ•ˆæœæ¨¡å—

#### èšåˆå…³ç³» (Aggregation)  
- **ToolManager** èšåˆ **ToolFactory**
- **ToolFactory** ç®¡ç† **DrawTool** å®ä¾‹

#### ç»§æ‰¿å…³ç³» (Inheritance)
- æ‰€æœ‰å…·ä½“å·¥å…·ç»§æ‰¿è‡ª **DrawTool** æŠ½è±¡åŸºç±»

#### ä¾èµ–å…³ç³» (Dependency)
- **ToolFactory** åˆ›å»ºå¹¶ä¾èµ– **DrawTool** å®ä¾‹

### ğŸ—ï¸ è®¾è®¡æ¨¡å¼ä½“ç°

1. **é—¨é¢æ¨¡å¼**: DrawBoard ä½œä¸ºç»Ÿä¸€å…¥å£
2. **å·¥å‚æ¨¡å¼**: ToolFactory è´Ÿè´£å·¥å…·åˆ›å»º
3. **ç­–ç•¥æ¨¡å¼**: å¤šç§æ¸²æŸ“å™¨å¯äº’æ¢
4. **è§‚å¯Ÿè€…æ¨¡å¼**: EventManager äº‹ä»¶ç³»ç»Ÿ
5. **å‘½ä»¤æ¨¡å¼**: HistoryManager å‘½ä»¤å†å²

### âš¡ æ¶æ„ä¼˜åŠ¿

- **ä½è€¦åˆ**: æ¨¡å—é—´ä¾èµ–å…³ç³»æ¸…æ™°
- **é«˜å†…èš**: æ¯ä¸ªç±»èŒè´£å•ä¸€
- **æ˜“æ‰©å±•**: æ”¯æŒæ–°å·¥å…·å’Œæ¸²æŸ“å™¨
- **æ˜“æµ‹è¯•**: æ¨¡å—å¯ç‹¬ç«‹æµ‹è¯• 