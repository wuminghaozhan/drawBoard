# DrawBoard æ ¸å¿ƒç±»å›¾

## ç³»ç»Ÿæ ¸å¿ƒç±»ç»“æ„

è¿™ä¸ªç±»å›¾å±•ç¤ºäº† DrawBoard ç³»ç»Ÿä¸­æ ¸å¿ƒç±»çš„ç»“æ„ã€å±æ€§ã€æ–¹æ³•ä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚

```mermaid
classDiagram
    class DrawBoard {
        -static instances: WeakMap~HTMLElement, DrawBoard~
        -errorHandler: ErrorHandler
        -resourceManager?: LightweightResourceManager
        -canvasEngine: CanvasEngine
        -toolManager: ToolManager
        -historyManager: HistoryManager
        -eventManager: EventManager
        -shortcutManager: ShortcutManager
        -exportManager: ExportManager
        -selectionManager: SelectionManager
        -performanceManager: PerformanceManager
        -complexityManager: ComplexityManager
        -virtualLayerManager: VirtualLayerManager
        -drawingHandler: DrawingHandler
        -cursorHandler: CursorHandler
        -stateHandler: StateHandler
        -container: HTMLElement
        +static getInstance(container, config): DrawBoard
        +static destroyInstance(container): boolean
        +setTool(tool: ToolType): Promise~void~
        +setColor(color: string): void
        +setLineWidth(width: number): void
        +undo(): Promise~boolean~
        +redo(): Promise~boolean~
        +clear(): Promise~void~
        +getState(): DrawBoardState
        +destroy(): Promise~void~
    }
    
    class CanvasEngine {
        -layers: Map~string, CanvasLayer~
        -width: number
        -height: number
        -contextCache: Map~string, DrawContext~
        +createLayer(name: string, zIndex: number): void
        +getLayer(name: string): CanvasLayer
        +getDrawLayer(): CanvasRenderingContext2D
        +getInteractionLayer(): CanvasRenderingContext2D
        +getBackgroundLayer(): CanvasRenderingContext2D
        +clear(layerName?: string): void
        +resize(): void
        +setContext(context: DrawContext): void
        +setLayerVisible(name: string, visible: boolean): void
    }
    
    class ToolManager {
        -currentTool: ToolType
        -currentToolInstance: DrawTool
        -toolFactory: ToolFactory
        -toolLoadingState: 'idle' | 'loading' | 'ready' | 'error'
        +setCurrentTool(type: ToolType): Promise~void~
        +getCurrentTool(): DrawTool
        +getAvailableToolTypes(): ToolType[]
        +getToolLoadingState(): 'idle' | 'loading' | 'ready' | 'error'
        +getToolMetadata(type: ToolType): ToolMetadata
    }
    
    class ToolFactory {
        -tools: Map~ToolType, DrawTool~
        -factories: Map~ToolType, Function~
        +register(type: ToolType, factory: Function): void
        +createTool(type: ToolType): Promise~DrawTool~
        +getAvailableToolTypes(): ToolType[]
        +preloadTool(type: ToolType): Promise~void~
    }
    
    class DrawTool {
        <<abstract>>
        +name: string
        +type: string
        +draw(ctx: CanvasRenderingContext2D, action: DrawAction): void*
        +getActionType(): string*
        #setContext(ctx: CanvasRenderingContext2D, context: DrawContext): void
        +setPerformanceMode(mode: PerformanceMode): void
    }
    
    class PenToolRefactored {
        -strokeConfig: StrokeConfig
        -calculator: StrokeCalculator
        -bezierRenderer: BezierRenderer
        -realtimeRenderer: RealtimeRenderer
        +draw(ctx: CanvasRenderingContext2D, action: DrawAction): void
        +setStrokeConfig(config: StrokeConfig): void
        +setPreset(preset: StrokePresetType): void
        +getStrokeConfig(): StrokeConfig
    }
    
    class TransformToolRefactored {
        -selectedAction: DrawAction
        -controlPoints: ControlPoint[]
        -activeOperation: TransformOperation
        -controlPointGenerator: ControlPointGenerator
        +setSelectedAction(action: DrawAction): void
        +startTransform(controlPoint: ControlPoint, startPoint: Point): void
        +updateTransform(currentPoint: Point): DrawAction
        +finishTransform(): DrawAction
        +draw(ctx: CanvasRenderingContext2D): void
    }
    
    class DrawingHandler {
        -toolManager: ToolManager
        -canvasEngine: CanvasEngine
        -historyManager: HistoryManager
        -virtualLayerManager?: VirtualLayerManager
        -onStateChange: () => void
        -isDrawing: boolean
        -currentAction: DrawAction
        -redrawScheduled: boolean
        +handleDrawStart(event: DrawEvent): void
        +handleDrawMove(event: DrawEvent): void
        +handleDrawEnd(event: DrawEvent): Promise~void~
        +redraw(): void
    }
    
    class StateHandler {
        -toolManager: ToolManager
        -historyManager: HistoryManager
        -selectionManager: SelectionManager
        -performanceManager: PerformanceManager
        -drawingHandler?: DrawingHandler
        -stateChangeCallbacks: Array~(state: DrawBoardState) => void~
        +getState(): DrawBoardState
        +emitStateChange(): void
        +onStateChange(callback: (state: DrawBoardState) => void): () => void
        +setDrawingHandler(handler: DrawingHandler): void
    }
    
    class CursorHandler {
        -container: HTMLElement
        -canvas?: HTMLCanvasElement
        -currentCursor: string
        +updateCursor(tool: ToolType): void
        +showDrawingCursor(): void
        +showDefaultCursor(): void
        +setCustomCursor(cursor: string): void
    }
    
    class EventManager {
        -canvas: HTMLCanvasElement
        -handlers: Map~string, EventHandler[]~
        -mouseMoveThrottle: Throttle
        +on(event: string, handler: EventHandler): void
        +emit(event: string, data: any): void
        +bindEvents(): void
        +unbindEvents(): void
    }
    
    class HistoryManager {
        -actions: DrawAction[]
        -currentIndex: number
        -maxHistorySize: number
        +addAction(action: DrawAction): void
        +undo(): DrawAction[]
        +redo(): DrawAction[]
        +clear(): void
        +canUndo(): boolean
        +canRedo(): boolean
        +getHistory(): DrawAction[]
    }
    
    class PerformanceManager {
        -config: PerformanceConfig
        -cacheMap: Map~string, PreRenderedCache~
        -memoryStats: MemoryStats
        +shouldCache(action: DrawAction): boolean
        +createCache(action: DrawAction, canvas: HTMLCanvasElement): PreRenderedCache
        +drawFromCache(ctx: CanvasRenderingContext2D, action: DrawAction): boolean
        +getCurrentMemoryUsage(): number
        +getMemoryStats(): MemoryStats
        +clearCache(): void
        +setPerformanceMode(mode: PerformanceMode): void
    }
    
    class VirtualLayerManager {
        -virtualLayers: Map~string, VirtualLayer~
        -actionLayerMap: Map~string, string~
        -activeLayerId: string
        -maxLayers: number
        +createVirtualLayer(name?: string): VirtualLayer
        +deleteVirtualLayer(layerId: string): boolean
        +setActiveVirtualLayer(layerId: string): boolean
        +getActiveVirtualLayer(): VirtualLayer
        +getAllVirtualLayers(): VirtualLayer[]
        +setVirtualLayerVisible(layerId: string, visible: boolean): boolean
        +setVirtualLayerOpacity(layerId: string, opacity: number): boolean
        +setVirtualLayerLocked(layerId: string, locked: boolean): boolean
    }
    
    class ErrorHandler {
        -errorHistory: DrawBoardError[]
        -errorCallbacks: Map~DrawBoardErrorCode, Array~(error: DrawBoardError) => void~
        -recoveryStrategies: Map~DrawBoardErrorCode, ErrorRecoveryStrategy~
        +static getInstance(): ErrorHandler
        +handle(error: DrawBoardError): void
        +onError(code: DrawBoardErrorCode, callback: (error: DrawBoardError) => void): () => void
        +getErrorHistory(): DrawBoardError[]
        +clearErrorHistory(): void
        +getErrorStats(): { total: number; byCode: Map~DrawBoardErrorCode, number~ }
    }
    
    class LightweightResourceManager {
        -resources: Map~string, DestroyableResource~
        -resourceStats: ResourceStats
        +register(name: string, resource: DestroyableResource): void
        +unregister(name: string): boolean
        +destroy(name: string): boolean
        +destroyAll(): void
        +getResourceStats(): ResourceStats
        +checkResourceLeaks(): { leaked: string[]; total: number }
    }
    
    DrawBoard --> CanvasEngine
    DrawBoard --> ToolManager
    DrawBoard --> EventManager
    DrawBoard --> HistoryManager
    DrawBoard --> PerformanceManager
    DrawBoard --> VirtualLayerManager
    DrawBoard --> ErrorHandler
    DrawBoard --> LightweightResourceManager
    DrawBoard --> DrawingHandler
    DrawBoard --> StateHandler
    DrawBoard --> CursorHandler
    
    ToolManager --> ToolFactory
    ToolFactory ..> DrawTool : creates
    DrawTool <|-- PenToolRefactored
    DrawTool <|-- TransformToolRefactored
    DrawTool <|-- RectTool
    DrawTool <|-- CircleTool
    DrawTool <|-- SelectTool
    DrawTool <|-- TextTool
    DrawTool <|-- EraserTool
    
    DrawingHandler --> ToolManager
    DrawingHandler --> CanvasEngine
    DrawingHandler --> HistoryManager
    DrawingHandler --> VirtualLayerManager
    
    StateHandler --> ToolManager
    StateHandler --> HistoryManager
    StateHandler --> PerformanceManager
    StateHandler --> DrawingHandler
    
    CursorHandler --> EventManager
    
    CanvasEngine --> CanvasLayer
    VirtualLayerManager --> VirtualLayer
    PerformanceManager --> PreRenderedCache
    ErrorHandler --> DrawBoardError
```

## ç±»å…³ç³»è¯´æ˜

### ğŸ¯ æ ¸å¿ƒå…³ç³»

#### ç»„åˆå…³ç³» (Composition)
- **DrawBoard** ç»„åˆäº†æ‰€æœ‰æ ¸å¿ƒç®¡ç†å™¨ã€å¤„ç†å™¨å’Œå¼•æ“
- **PenToolRefactored** ç»„åˆäº†è¿ç¬”æ•ˆæœæ¨¡å—
- **TransformToolRefactored** ç»„åˆäº†æ§åˆ¶ç‚¹ç”Ÿæˆå™¨

#### èšåˆå…³ç³» (Aggregation)  
- **ToolManager** èšåˆ **ToolFactory**
- **ToolFactory** ç®¡ç† **DrawTool** å®ä¾‹
- **DrawingHandler** èšåˆå„ç§ç®¡ç†å™¨

#### ç»§æ‰¿å…³ç³» (Inheritance)
- æ‰€æœ‰å…·ä½“å·¥å…·ç»§æ‰¿è‡ª **DrawTool** æŠ½è±¡åŸºç±»

#### ä¾èµ–å…³ç³» (Dependency)
- **ToolFactory** åˆ›å»ºå¹¶ä¾èµ– **DrawTool** å®ä¾‹
- **StateHandler** ä¾èµ– **DrawingHandler**

### ğŸ—ï¸ è®¾è®¡æ¨¡å¼ä½“ç°

1. **é—¨é¢æ¨¡å¼**: DrawBoard ä½œä¸ºç»Ÿä¸€å…¥å£
2. **å·¥å‚æ¨¡å¼**: ToolFactory è´Ÿè´£å·¥å…·åˆ›å»º
3. **ç­–ç•¥æ¨¡å¼**: å¤šç§æ¸²æŸ“å™¨å¯äº’æ¢
4. **è§‚å¯Ÿè€…æ¨¡å¼**: EventManager äº‹ä»¶ç³»ç»Ÿ
5. **å‘½ä»¤æ¨¡å¼**: HistoryManager å‘½ä»¤å†å²
6. **å•ä¾‹æ¨¡å¼**: DrawBoard å®ä¾‹ç®¡ç†
7. **å¤„ç†å™¨æ¨¡å¼**: èŒè´£åˆ†ç¦»çš„å¤„ç†å™¨

### âš¡ æ¶æ„ä¼˜åŠ¿

- **ä½è€¦åˆ**: æ¨¡å—é—´ä¾èµ–å…³ç³»æ¸…æ™°
- **é«˜å†…èš**: æ¯ä¸ªç±»èŒè´£å•ä¸€
- **æ˜“æ‰©å±•**: æ”¯æŒæ–°å·¥å…·å’Œæ¸²æŸ“å™¨
- **æ˜“æµ‹è¯•**: æ¨¡å—å¯ç‹¬ç«‹æµ‹è¯•
- **é«˜æ€§èƒ½**: å¤šå±‚ç¼“å­˜å’Œä¼˜åŒ–
- **ç¨³å®šæ€§**: å®Œå–„çš„é”™è¯¯å¤„ç† 