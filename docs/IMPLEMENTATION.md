# ğŸ”§ DrawBoard å®ç°æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿° DrawBoard ç³»ç»Ÿçš„å…³é”®å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬åŠ¨æ€å›¾å±‚å®ç°ã€é€‰æ‹©å·¥å…·å®ç°ã€é”šç‚¹äº¤äº’è§„èŒƒç­‰ã€‚

---

## 1. åŠ¨æ€ç‰©ç†å›¾å±‚å®ç°

### 1.1 å®ç°æ¦‚è¿°

æˆåŠŸå®ç°äº†åŠ¨æ€ç‰©ç†å›¾å±‚ç³»ç»Ÿï¼Œè§£å†³äº†é€‰ä¸­è™šæ‹Ÿå›¾å±‚çš„äº¤äº’å…ƒç´ ï¼ˆé”šç‚¹ã€æ§åˆ¶ç‚¹ã€å˜å½¢æ¡†ï¼‰é®æŒ¡ä¸Šå±‚å›¾å±‚çš„é—®é¢˜ã€‚

### 1.2 æ¶æ„æ”¹è¿›

**æ”¹è¿›å‰ï¼š**
```
interactionå±‚ (z-index: 2) â† æ‰€æœ‰äº¤äº’å…ƒç´ ï¼ˆæœ€ä¸Šå±‚ï¼Œä¼šé®æŒ¡ä¸Šå±‚å›¾å±‚ï¼‰
drawå±‚ (z-index: 1)        â† æ‰€æœ‰è™šæ‹Ÿå›¾å±‚å†…å®¹
backgroundå±‚ (z-index: 0)  â† èƒŒæ™¯ã€ç½‘æ ¼
```

**æ”¹è¿›åï¼š**
```
interactionå±‚ (z-index: 4)         â† å…¨å±€äº¤äº’ï¼ˆå®æ—¶é¢„è§ˆã€ä¸´æ—¶é€‰æ‹©æ¡†ï¼‰
åŠ¨æ€é€‰ä¸­å±‚ (z-index: 35)            â† å›¾å±‚3çš„äº¤äº’å…ƒç´ ï¼ˆå¦‚æœå›¾å±‚3è¢«é€‰ä¸­ï¼ŒzIndex=3ï¼‰
drawå±‚-å›¾å±‚3 (z-index: 3)           â† è™šæ‹Ÿå›¾å±‚3å†…å®¹
åŠ¨æ€é€‰ä¸­å±‚ (z-index: 25)            â† å›¾å±‚2çš„äº¤äº’å…ƒç´ ï¼ˆå¦‚æœå›¾å±‚2è¢«é€‰ä¸­ï¼ŒzIndex=2ï¼‰
drawå±‚-å›¾å±‚2 (z-index: 2)           â† è™šæ‹Ÿå›¾å±‚2å†…å®¹
drawå±‚-å›¾å±‚1 (z-index: 1)           â† è™šæ‹Ÿå›¾å±‚1å†…å®¹
backgroundå±‚ (z-index: 0)          â† èƒŒæ™¯ã€ç½‘æ ¼
```

### 1.3 æ ¸å¿ƒå®ç°

#### CanvasEngine æ‰©å±•

**æ–°å¢åŠŸèƒ½ï¼š**
- `createDynamicLayer(layerId, zIndex)`: åˆ›å»ºåŠ¨æ€å›¾å±‚
- `removeDynamicLayer(layerId)`: åˆ é™¤åŠ¨æ€å›¾å±‚
- `getSelectionLayerForVirtualLayer(virtualLayerZIndex)`: è·å–é€‰ä¸­å›¾å±‚çš„äº¤äº’å±‚
- `updateDynamicLayerZIndex(layerId, newZIndex)`: æ›´æ–°åŠ¨æ€å›¾å±‚zIndex

**zIndexè®¡ç®—å…¬å¼ï¼š**
```typescript
// åŠ¨æ€å›¾å±‚zIndex = virtualLayerZIndex * 10 + 5
// ä¾‹å¦‚ï¼š
// è™šæ‹Ÿå›¾å±‚zIndex=0 â†’ åŠ¨æ€å›¾å±‚zIndex=5
// è™šæ‹Ÿå›¾å±‚zIndex=1 â†’ åŠ¨æ€å›¾å±‚zIndex=15
// è™šæ‹Ÿå›¾å±‚zIndex=2 â†’ åŠ¨æ€å›¾å±‚zIndex=25
```

#### VirtualLayerManager é›†æˆ

**æ–°å¢åŠŸèƒ½ï¼š**
- æ„é€ å‡½æ•°æ¥æ”¶`CanvasEngine`å¼•ç”¨
- `setCanvasEngine(canvasEngine)`: è®¾ç½®CanvasEngineå¼•ç”¨
- `setHistoryManager(historyManager)`: è®¾ç½®HistoryManagerå¼•ç”¨
- `getActiveVirtualLayerZIndex()`: è·å–æ´»åŠ¨è™šæ‹Ÿå›¾å±‚çš„zIndex
- `clearActiveLayer()`: æ¸…é™¤æ´»åŠ¨å›¾å±‚ï¼ˆåˆ é™¤åŠ¨æ€å›¾å±‚ï¼‰
- `getLastActionInLayer(layerId)`: ä»HistoryManagerè·å–å›¾å±‚æœ€åä¸€ä¸ªåŠ¨ä½œ

**æ ¸å¿ƒé€»è¾‘ï¼š**
- å›¾å±‚è¢«é€‰ä¸­æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„åŠ¨æ€å›¾å±‚
- å›¾å±‚å–æ¶ˆé€‰ä¸­æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤åŠ¨æ€å›¾å±‚
- å›¾å±‚é¡ºåºå˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°åŠ¨æ€å›¾å±‚çš„zIndexå’Œä½ç½®
- å·¥å…·ç±»å‹å˜åŒ–æ£€æµ‹ï¼šé€šè¿‡HistoryManagerè·å–æœ€åä¸€ä¸ªåŠ¨ä½œï¼Œæ£€æµ‹å·¥å…·ç±»å‹å˜åŒ–

#### SelectTool å’Œ TransformTool é›†æˆ

**æ–°å¢åŠŸèƒ½ï¼š**
- `setCanvasEngine(canvasEngine, selectedLayerZIndex)`: è®¾ç½®CanvasEngineå’Œé€‰ä¸­å›¾å±‚zIndex
- `getInteractionContext()`: è·å–ç”¨äºç»˜åˆ¶äº¤äº’å…ƒç´ çš„Canvasä¸Šä¸‹æ–‡

**æ ¸å¿ƒé€»è¾‘ï¼š**
- å¦‚æœæä¾›äº†`selectedLayerZIndex`ï¼Œä½¿ç”¨åŠ¨æ€å›¾å±‚ç»˜åˆ¶
- å¦åˆ™ä½¿ç”¨interactionå±‚ç»˜åˆ¶ï¼ˆå‘åå…¼å®¹ï¼‰
- æ‰€æœ‰äº¤äº’å…ƒç´ ï¼ˆé€‰æ‹©æ¡†ã€é”šç‚¹ã€æ§åˆ¶ç‚¹ã€å˜å½¢æ¡†ï¼‰éƒ½ä½¿ç”¨åŠ¨æ€å›¾å±‚

### 1.4 ä½¿ç”¨æµç¨‹

#### å›¾å±‚é€‰æ‹©æµç¨‹
```typescript
// ç”¨æˆ·é€‰æ‹©å›¾å±‚
drawBoard.setActiveVirtualLayer(layerId);

// VirtualLayerManagerå†…éƒ¨ï¼š
1. æ¸…é™¤ä¹‹å‰çš„åŠ¨æ€å›¾å±‚
2. åˆ›å»ºæ–°çš„åŠ¨æ€å›¾å±‚ï¼ˆzIndex = layer.zIndex * 10 + 5ï¼‰
3. æ›´æ–°activeLayerId

// SelectToolåŒæ­¥ï¼š
1. syncLayerDataToSelectTool()è¢«è°ƒç”¨
2. è·å–é€‰ä¸­å›¾å±‚çš„zIndex
3. è°ƒç”¨selectTool.setCanvasEngine(canvasEngine, selectedLayerZIndex)
4. SelectToolä½¿ç”¨åŠ¨æ€å›¾å±‚ç»˜åˆ¶äº¤äº’å…ƒç´ 
```

#### å›¾å±‚é¡ºåºè°ƒæ•´æµç¨‹
```typescript
// ç”¨æˆ·è°ƒæ•´å›¾å±‚é¡ºåº
drawBoard.reorderVirtualLayer(layerId, newIndex);

// VirtualLayerManagerå†…éƒ¨ï¼š
1. é‡æ–°åˆ†é…zIndex
2. å¦‚æœç§»åŠ¨çš„å›¾å±‚æ˜¯æ´»åŠ¨å›¾å±‚ï¼š
   - åˆ é™¤æ—§çš„åŠ¨æ€å›¾å±‚
   - åˆ›å»ºæ–°çš„åŠ¨æ€å›¾å±‚ï¼ˆä½¿ç”¨æ–°çš„zIndexï¼‰
3. å¦‚æœå—å½±å“çš„å›¾å±‚æ˜¯æ´»åŠ¨å›¾å±‚ï¼š
   - æ›´æ–°åŠ¨æ€å›¾å±‚çš„zIndexå’Œä½ç½®
```

### 1.5 ä¼˜åŠ¿

1. **è§†è§‰æ­£ç¡®** - äº¤äº’å…ƒç´ æ˜¾ç¤ºåœ¨æ­£ç¡®çš„ä½ç½®ï¼Œä¸ä¼šé®æŒ¡ä¸Šå±‚å›¾å±‚
2. **æ€§èƒ½å¯æ§** - æŒ‰éœ€åˆ›å»ºï¼ŒåŠæ—¶é”€æ¯ï¼Œé¿å…å›ºå®šå¼€é”€
3. **çµæ´»æ€§å¼º** - æ”¯æŒä»»æ„æ•°é‡çš„é€‰ä¸­å›¾å±‚
4. **å‘åå…¼å®¹** - æœªé€‰ä¸­å›¾å±‚æ—¶ï¼Œä»ä½¿ç”¨interactionå±‚
5. **è‡ªåŠ¨ç®¡ç†** - å›¾å±‚é€‰æ‹©ã€é¡ºåºå˜åŒ–æ—¶è‡ªåŠ¨åˆ›å»º/æ›´æ–°/é”€æ¯åŠ¨æ€å›¾å±‚

---

## 2. é€‰æ‹©å·¥å…·å®ç°

### 2.1 é€‰æ‹©å·¥å…·æ¶æ„

é€‰æ‹©å·¥å…·ï¼ˆSelectToolï¼‰è´Ÿè´£å¤„ç†å›¾å½¢é€‰æ‹©ã€ç§»åŠ¨ã€ç¼©æ”¾ã€æ—‹è½¬ç­‰æ“ä½œã€‚

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- ç‚¹é€‰å’Œæ¡†é€‰
- ç§»åŠ¨é€‰ä¸­å›¾å½¢
- ç¼©æ”¾å’Œæ—‹è½¬
- é”šç‚¹æ‹–æ‹½äº¤äº’
- å¤šé€‰æ”¯æŒ

### 2.2 é€‰æ‹©é€»è¾‘

#### ç‚¹é€‰æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»
  â†“
handleMouseDown()
  â†“
selectActionAtPoint()
  â†“
éå† allActionsï¼ˆä»åå¾€å‰ï¼‰
  â†“
isPointInAction() æ£€æŸ¥
  â†“
æ‰¾åˆ° â†’ selectSingleAction()
æœªæ‰¾åˆ° â†’ clearSelection()
```

#### æ¡†é€‰æµç¨‹
```
ç”¨æˆ·æ‹–æ‹½æ¡†é€‰
  â†“
handleMouseDown() â†’ isSelecting = true
  â†“
handleMouseMove() â†’ æ›´æ–° currentSelectionBounds
  â†“
handleMouseUp()
  â†“
selectActionsInBox()
  â†“
éå† allActions
  â†“
æ£€æŸ¥è¾¹ç•Œæ¡†ç›¸äº¤
  â†“
è¿”å›é€‰ä¸­çš„actions
```

### 2.3 å›¾å±‚åˆ‡æ¢å¤„ç†

**å…³é”®ä¿®å¤ï¼š**
- å›¾å±‚åˆ‡æ¢æ—¶æ¸…ç©ºé€‰æ‹©
- æ›´æ–°SelectToolçš„allActions
- é‡ç½®SelectToolçŠ¶æ€
- éªŒè¯é€‰ä¸­actionsçš„æœ‰æ•ˆæ€§

**å®ç°ï¼š**
```typescript
// åœ¨ syncLayerDataToSelectTool ä¸­
selectTool.setLayerActions(layerActions, clearSelection=true);
selectTool.clearSelection();
selectTool.reset();
```

### 2.4 æ‹–æ‹½é”šç‚¹å¤„ç†

**å…³é”®ä¿®å¤ï¼š**
- æ‹–æ‹½é”šç‚¹åæ›´æ–°HistoryManager
- æ ‡è®°å›¾å±‚ç¼“å­˜è¿‡æœŸ
- è§¦å‘é‡ç»˜

**å®ç°æµç¨‹ï¼š**
```
ç”¨æˆ·æ‹–æ‹½é”šç‚¹
  â†“
handleMouseDown() â†’ isDraggingAnchor = true
  â†“
handleMouseMove() â†’ handleAnchorDrag()
  â†“
è®¡ç®—æ–°è¾¹ç•Œæ¡† â†’ scaleSelectedActions() â†’ æ›´æ–°points
  â†“
handleMouseUp() â†’ è¿”å›æ›´æ–°åçš„actions
  â†“
DrawBoard.handleDrawEnd()
  â†“
handleUpdatedActions()
  â†“
1. HistoryManager.updateAction()
2. VirtualLayerManager.markLayerCacheDirty()
3. DrawingHandler.forceRedraw()
```

---

## 3. é”šç‚¹äº¤äº’è§„èŒƒ

### 3.1 é”šç‚¹ç±»å‹å®šä¹‰

æ‰€æœ‰å›¾å½¢ä½¿ç”¨ç»Ÿä¸€çš„ 8 ä¸ªé”šç‚¹å¸ƒå±€ï¼š

```
    top-left â”€â”€â”€â”€â”€â”€â”€â”€ top â”€â”€â”€â”€â”€â”€â”€â”€ top-right
         â”‚                              â”‚
         â”‚                              â”‚
       left                            right
         â”‚                              â”‚
         â”‚                              â”‚
    bottom-left â”€â”€â”€â”€ bottom â”€â”€â”€â”€ bottom-right
```

**é”šç‚¹åˆ†ç±»ï¼š**
- **è§’ç‚¹ï¼ˆCornerï¼‰**: 4ä¸ªï¼Œä½äºå›¾å½¢çš„å››ä¸ªè§’
- **è¾¹ä¸­ç‚¹ï¼ˆEdgeï¼‰**: 4ä¸ªï¼Œä½äºå›¾å½¢çš„å››æ¡è¾¹çš„ä¸­ç‚¹
- **ä¸­å¿ƒç‚¹ï¼ˆCenterï¼‰**: 1ä¸ªï¼ˆå¯é€‰ï¼‰ï¼Œä½äºå›¾å½¢ä¸­å¿ƒ

### 3.2 å›¾å½¢ç±»å‹äº¤äº’è§„èŒƒ

#### åœ†å½¢ï¼ˆCircleï¼‰

**é”šç‚¹å¸ƒå±€ï¼š**
- ä¸­å¿ƒç‚¹ï¼šåœ†å¿ƒä½ç½®ï¼ˆç”¨äºç§»åŠ¨æ•´ä¸ªåœ†ï¼‰
- 8ä¸ªè¾¹ç•Œæ¡†é”šç‚¹ï¼šåŸºäºåœ†å½¢è¾¹ç•Œæ¡†çš„8ä¸ªæ ‡å‡†é”šç‚¹

**äº¤äº’è¡Œä¸ºï¼š**
- ä¸­å¿ƒç‚¹æ‹–æ‹½ â†’ ç§»åŠ¨æ•´ä¸ªåœ†
- è¾¹ç¼˜é”šç‚¹æ‹–æ‹½ â†’ æ”¹å˜åŠå¾„ï¼Œåœ†å¿ƒä¿æŒä¸å˜

**å…³é”®ç®—æ³•ï¼ˆå·²ä¼˜åŒ–ï¼‰ï¼š**
```typescript
// è®¡ç®—é¼ æ ‡åˆ°åœ†å¿ƒçš„è·ç¦»ï¼ˆè¿™å°±æ˜¯æ–°åŠå¾„ï¼‰
const mouseToCenterDistance = Math.sqrt(
  Math.pow(currentPoint.x - center.x, 2) + 
  Math.pow(currentPoint.y - center.y, 2)
);

// æ–°åŠå¾„ = é¼ æ ‡åˆ°åœ†å¿ƒçš„è·ç¦»ï¼ˆç›´æ¥ä½¿ç”¨ï¼Œç²¾ç¡®æ§åˆ¶ï¼‰
const newRadius = mouseToCenterDistance;

// è®¡ç®—è¾¹ç¼˜ç‚¹ä½ç½®ï¼šè·Ÿéšé¼ æ ‡æ–¹å‘
const angle = Math.atan2(currentPoint.y - center.y, currentPoint.x - center.x);
const newEdgeX = center.x + clampedRadius * Math.cos(angle);
const newEdgeY = center.y + clampedRadius * Math.sin(angle);
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… ç›´æ¥ä½¿ç”¨é¼ æ ‡åˆ°åœ†å¿ƒçš„è·ç¦»ä½œä¸ºæ–°åŠå¾„ï¼Œç²¾ç¡®æ§åˆ¶
- âœ… è¾¹ç¼˜ç‚¹è·Ÿéšé¼ æ ‡æ–¹å‘ï¼Œæä¾›ç›´è§‚çš„äº¤äº’ä½“éªŒ
- âœ… åœ†å½¢æ‹–æ‹½ä¸åº”ç”¨æ•æ„Ÿåº¦å› å­ï¼Œä¿æŒç²¾ç¡®æ€§

#### çŸ©å½¢ï¼ˆRectangleï¼‰

**é”šç‚¹å¸ƒå±€ï¼š**
- 8ä¸ªæ ‡å‡†é”šç‚¹ï¼š4ä¸ªè§’ç‚¹ + 4ä¸ªè¾¹ä¸­ç‚¹
- ä¸­å¿ƒç‚¹ï¼šçŸ©å½¢ä¸­å¿ƒï¼ˆç”¨äºç§»åŠ¨ï¼‰

**äº¤äº’è¡Œä¸ºï¼š**
- ä¸­å¿ƒç‚¹æ‹–æ‹½ â†’ ç§»åŠ¨æ•´ä¸ªçŸ©å½¢
- è¾¹ä¸­ç‚¹æ‹–æ‹½ â†’ åªæ”¹å˜å¯¹åº”è¾¹çš„ä½ç½®å’Œå°ºå¯¸
- è§’ç‚¹æ‹–æ‹½ â†’ åŒæ—¶æ”¹å˜ä¸¤ä¸ªç›¸é‚»è¾¹çš„ä½ç½®å’Œå°ºå¯¸

#### æ–‡å­—ï¼ˆTextï¼‰

**é”šç‚¹å¸ƒå±€ï¼š**
- 8ä¸ªæ ‡å‡†é”šç‚¹ï¼šåŸºäºæ–‡å­—è¾¹ç•Œæ¡†
- ä¸­å¿ƒç‚¹ï¼šæ–‡å­—ä¸­å¿ƒï¼ˆç”¨äºç§»åŠ¨ï¼‰

**äº¤äº’è¡Œä¸ºï¼š**
- ä¸­å¿ƒç‚¹æ‹–æ‹½ â†’ ç§»åŠ¨æ–‡å­—ä½ç½®
- è¾¹ç¼˜é”šç‚¹æ‹–æ‹½ â†’ æ”¹å˜å­—ä½“å¤§å°ï¼Œä½ç½®ä¿æŒä¸å˜

**å­—ä½“å¤§å°è®¡ç®—ï¼š**
```typescript
// è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆä½¿ç”¨ç­‰æ¯”ä¾‹ç¼©æ”¾ï¼Œä¿æŒæ–‡å­—æ¯”ä¾‹ï¼‰
const scaleX = newBounds.width / dragStartBounds.width;
const scaleY = newBounds.height / dragStartBounds.height;
const uniformScale = Math.min(scaleX, scaleY);

// è®¡ç®—æ–°çš„å­—ä½“å¤§å°
let newFontSize = originalFontSize * uniformScale;

// é™åˆ¶å­—ä½“å¤§å°èŒƒå›´
const MIN_FONT_SIZE = 8;
const MAX_FONT_SIZE = 72;
newFontSize = Math.max(MIN_FONT_SIZE, Math.min(MAX_FONT_SIZE, newFontSize));
```

#### ç›´çº¿ï¼ˆLineï¼‰

**é”šç‚¹å¸ƒå±€ï¼š**
- èµ·ç‚¹é”šç‚¹ï¼šèµ·ç‚¹ä½ç½®
- ç»ˆç‚¹é”šç‚¹ï¼šç»ˆç‚¹ä½ç½®
- ä¸­å¿ƒç‚¹ï¼šçº¿æ®µä¸­ç‚¹ï¼ˆç”¨äºç§»åŠ¨ï¼‰

**äº¤äº’è¡Œä¸ºï¼š**
- ä¸­å¿ƒç‚¹æ‹–æ‹½ â†’ ç§»åŠ¨æ•´æ¡ç›´çº¿
- èµ·ç‚¹/ç»ˆç‚¹é”šç‚¹æ‹–æ‹½ â†’ æ”¹å˜å¯¹åº”ç«¯ç‚¹ä½ç½®

### 3.3 å¤šé€‰åœºæ™¯è§„èŒƒ

**å¤šé€‰å®šä¹‰ï¼š** åŒæ—¶é€‰ä¸­å¤šä¸ªå›¾å½¢ï¼ˆ2ä¸ªæˆ–æ›´å¤šï¼‰

**å¤šé€‰é”šç‚¹å¸ƒå±€ï¼š**
- ç»Ÿä¸€è¾¹ç•Œæ¡†ï¼šæ˜¾ç¤ºåŒ…å«æ‰€æœ‰é€‰ä¸­å›¾å½¢çš„ç»Ÿä¸€è¾¹ç•Œæ¡†
- 8ä¸ªæ ‡å‡†é”šç‚¹ï¼šåŸºäºç»Ÿä¸€è¾¹ç•Œæ¡†çš„8ä¸ªé”šç‚¹ï¼ˆ4ä¸ªè§’ç‚¹ + 4ä¸ªè¾¹ä¸­ç‚¹ï¼‰
- æ— ä¸­å¿ƒç‚¹ï¼šå¤šé€‰æ—¶ä¸æ˜¾ç¤ºä¸­å¿ƒç‚¹ï¼ˆé¿å…æ··æ·†ï¼‰

**å¤šé€‰äº¤äº’è¡Œä¸ºï¼š**
- **ç§»åŠ¨æ“ä½œ**ï¼šæ‰€æœ‰é€‰ä¸­å›¾å½¢åŒæ—¶ç§»åŠ¨ç›¸åŒè·ç¦»
- **ç¼©æ”¾æ“ä½œ**ï¼šæ‰€æœ‰é€‰ä¸­å›¾å½¢æŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼Œç¼©æ”¾ä¸­å¿ƒæ˜¯ç»Ÿä¸€è¾¹ç•Œæ¡†çš„ä¸­å¿ƒç‚¹

### 3.4 ä¸­å¿ƒç‚¹å®ç°ç»†èŠ‚

**ä¸­å¿ƒç‚¹å®šä¹‰ï¼š** ä½äºå›¾å½¢å‡ ä½•ä¸­å¿ƒçš„é”šç‚¹ï¼Œç”¨äºç§»åŠ¨æ•´ä¸ªå›¾å½¢

**ä¸­å¿ƒç‚¹è®¡ç®—ï¼š**
```typescript
function calculateCenterPoint(action: DrawAction): Point {
  switch (action.type) {
    case 'circle':
      return action.points[0]; // åœ†å¿ƒä½ç½®
    case 'rect':
      const bounds = getRectBounds(action);
      return { x: bounds.x + bounds.width / 2, y: bounds.y + bounds.height / 2 };
    case 'line':
      const start = action.points[0];
      const end = action.points[1];
      return { x: (start.x + end.x) / 2, y: (start.y + end.y) / 2 };
    // ... å…¶ä»–å›¾å½¢ç±»å‹
  }
}
```

**ä¸­å¿ƒç‚¹è§†è§‰æ ·å¼ï¼š**
- å¤§å°ï¼š8px Ã— 8pxï¼ˆä¸è¾¹é”šç‚¹ç›¸åŒï¼‰
- é¢œè‰²ï¼šå¡«å……ç™½è‰²ï¼Œè¾¹æ¡†è“è‰²ï¼ˆ#007AFFï¼‰ï¼Œçº¿å®½ 2px
- å½¢çŠ¶ï¼šåœ†å½¢ï¼ˆåŒºåˆ«äºæ–¹å½¢è¾¹é”šç‚¹ï¼‰
- å±‚çº§ï¼šæ˜¾ç¤ºåœ¨æ‰€æœ‰é”šç‚¹ä¹‹ä¸Šï¼ˆz-index æœ€é«˜ï¼‰

**ä¸­å¿ƒç‚¹æ˜¾ç¤º/éšè—è§„åˆ™ï¼š**
- æ˜¾ç¤ºæ¡ä»¶ï¼šæœ‰å›¾å½¢è¢«é€‰ä¸­ï¼Œä¸”é€‰ä¸­å›¾å½¢æ•°é‡ â‰¤ 1ï¼ˆå•ä¸ªå›¾å½¢æ˜¾ç¤ºä¸­å¿ƒç‚¹ï¼‰
- éšè—æ¡ä»¶ï¼šæ²¡æœ‰å›¾å½¢è¢«é€‰ä¸­ï¼Œæˆ–æ­£åœ¨æ‹–æ‹½å…¶ä»–é”šç‚¹ï¼Œæˆ–å¤šé€‰åœºæ™¯

### 3.5 é”®ç›˜å¿«æ·é”®è§„èŒƒ

#### ç§»åŠ¨å¿«æ·é”®
- **æ–¹å‘é”®ï¼ˆâ†‘â†“â†â†’ï¼‰**: ç§»åŠ¨é€‰ä¸­å›¾å½¢ï¼Œæ­¥é•¿1px
- **Shift + æ–¹å‘é”®**: 10px æ­¥é•¿
- **Ctrl/Cmd + æ–¹å‘é”®**: 0.1px å¾®è°ƒ

#### ç¼©æ”¾å¿«æ·é”®
- **Shift + æ–¹å‘é”®**: ç¼©æ”¾é€‰ä¸­å›¾å½¢
  - Shift + â†‘: é«˜åº¦å¢åŠ 
  - Shift + â†“: é«˜åº¦å‡å°‘
  - Shift + â†: å®½åº¦å‡å°‘
  - Shift + â†’: å®½åº¦å¢åŠ 

#### å…¶ä»–å¿«æ·é”®
- **Esc**: å–æ¶ˆé€‰æ‹©
- **Delete/Backspace**: åˆ é™¤é€‰ä¸­å›¾å½¢
- **Ctrl/Cmd + A**: å…¨é€‰
- **Ctrl/Cmd + D**: å–æ¶ˆé€‰æ‹©

---

## 4. å®ç°ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆå·²å®Œæˆï¼‰
1. âœ… **åŠ¨æ€ç‰©ç†å›¾å±‚** - è§£å†³äº¤äº’å…ƒç´ é®æŒ¡é—®é¢˜
2. âœ… **é€‰æ‹©å·¥å…·åŸºç¡€åŠŸèƒ½** - ç‚¹é€‰ã€æ¡†é€‰ã€ç§»åŠ¨
3. âœ… **å›¾å±‚åˆ‡æ¢å¤„ç†** - æ¸…ç©ºé€‰æ‹©ã€æ›´æ–°çŠ¶æ€

### ä¸­ä¼˜å…ˆçº§ï¼ˆå·²å®Œæˆï¼‰
4. âœ… **æ‹–æ‹½é”šç‚¹å¤„ç†** - æ›´æ–°HistoryManagerã€æ ‡è®°ç¼“å­˜
5. âœ… **åœ†å½¢é”šç‚¹äº¤äº’** - ä¸­å¿ƒç‚¹ç§»åŠ¨ã€è¾¹ç¼˜é”šç‚¹æ”¹å˜åŠå¾„
6. âœ… **çŸ©å½¢é”šç‚¹äº¤äº’** - è¾¹ä¸­ç‚¹ã€è§’ç‚¹æ‹–æ‹½

### ä½ä¼˜å…ˆçº§ï¼ˆå·²å®Œæˆï¼‰
7. âœ… **æ–‡å­—é”šç‚¹äº¤äº’** - è¾¹ç¼˜é”šç‚¹æ”¹å˜å­—ä½“å¤§å°ï¼ˆTextAnchorHandlerå·²å®ç°ï¼‰
8. âœ… **ç›´çº¿é”šç‚¹äº¤äº’** - èµ·ç‚¹/ç»ˆç‚¹ç‹¬ç«‹ç§»åŠ¨ï¼ˆLineAnchorHandlerå·²å®ç°ï¼‰

### ä½ä¼˜å…ˆçº§ï¼ˆè§„åˆ’ä¸­ï¼‰
9. â³ **å¤šè¾¹å½¢é”šç‚¹äº¤äº’** - é¡¶ç‚¹ç¼–è¾‘
10. â³ **è·¯å¾„é”šç‚¹äº¤äº’** - å…³é”®ç‚¹ç¼–è¾‘

---

## 5. æ€§èƒ½ä¼˜åŒ–å®ç°

### 5.1 ç¦»å±Canvasç¼“å­˜

**å®ç°ä½ç½®**: `DrawingHandler.performGeometricRedraw()`

**è§¦å‘æ¡ä»¶**:
- å†å²åŠ¨ä½œæ•°é‡è¶…è¿‡é˜ˆå€¼ï¼ˆ100ä¸ªï¼‰
- å¯ç”¨å‡ ä½•å›¾å½¢ä¼˜åŒ–ï¼ˆ`enableGeometricOptimization: true`ï¼‰

**å®ç°æœºåˆ¶**:
1. **åˆå§‹åŒ–ç¦»å±Canvas**: æŒ‰éœ€åˆ›å»ºï¼Œå°ºå¯¸ä¸ä¸»CanvasåŒæ­¥
2. **ç¼“å­˜å†å²åŠ¨ä½œ**: å°†æ‰€æœ‰å†å²åŠ¨ä½œç»˜åˆ¶åˆ°ç¦»å±Canvas
3. **ç¼“å­˜å¤±æ•ˆæœºåˆ¶**: æ–°åŠ¨ä½œæ·»åŠ ã€å†å²å˜åŒ–ã€æ’¤é”€/é‡åšæ—¶æ ‡è®°è¿‡æœŸ
4. **æ¸²æŸ“æµç¨‹**: ä¸»Canvasåªéœ€ç»˜åˆ¶ç¦»å±Canvaså’Œå½“å‰åŠ¨ä½œ

**æ€§èƒ½æå‡**:
- å†å²åŠ¨ä½œ 100-500ä¸ªï¼šæ€§èƒ½æå‡çº¦ 30-50%
- å†å²åŠ¨ä½œ 500-1000ä¸ªï¼šæ€§èƒ½æå‡çº¦ 50-70%
- å†å²åŠ¨ä½œ > 1000ä¸ªï¼šæ€§èƒ½æå‡çº¦ 70-90%

**å…³é”®æ–¹æ³•**:
- `initializeOffscreenCanvas()`: åˆå§‹åŒ–ç¦»å±Canvas
- `drawAllHistoryActionsToOffscreen()`: ç»˜åˆ¶å†å²åŠ¨ä½œåˆ°ç¦»å±Canvas
- `invalidateOffscreenCache()`: æ ‡è®°ç¼“å­˜è¿‡æœŸ

### 6.2 HistoryManageré›†æˆ

**å®ç°ä½ç½®**: `VirtualLayerManager`

**é›†æˆæ–¹å¼**:
1. é€šè¿‡ `setHistoryManager()` è®¾ç½®HistoryManagerå¼•ç”¨
2. `getLastActionInLayer()` ä»HistoryManagerè·å–åŠ¨ä½œæ•°æ®
3. æ”¯æŒå·¥å…·ç±»å‹å˜åŒ–æ£€æµ‹ï¼Œè‡ªåŠ¨åˆ›å»ºæ–°å›¾å±‚

**ä½¿ç”¨åœºæ™¯**:
- åˆ†ç»„æ¨¡å¼ä¸‹ï¼Œæ£€æµ‹å·¥å…·ç±»å‹å˜åŒ–
- å¦‚æœå·¥å…·ç±»å‹å˜åŒ–ï¼Œè‡ªåŠ¨åˆ›å»ºæ–°å›¾å±‚
- ç¡®ä¿åŒä¸€å›¾å±‚ä¸­çš„åŠ¨ä½œä½¿ç”¨ç›¸åŒå·¥å…·ç±»å‹

---

## 7. å‰ªè´´æ¿æ“ä½œå®ç°

### 7.1 å‰ªè´´æ¿åŠŸèƒ½

**å·²å®ç°åŠŸèƒ½ï¼š**
- âœ… `copySelection()` - å¤åˆ¶é€‰ä¸­å†…å®¹åˆ°å†…éƒ¨å‰ªè´´æ¿
- âœ… `pasteSelection(offsetX?, offsetY?)` - ç²˜è´´å‰ªè´´æ¿å†…å®¹ï¼Œæ”¯æŒåç§»
- âœ… `cutSelection()` - å‰ªåˆ‡é€‰ä¸­å†…å®¹ï¼ˆå…ˆå¤åˆ¶ååˆ é™¤ï¼‰
- âœ… `hasClipboardData()` - æ£€æŸ¥å‰ªè´´æ¿æ˜¯å¦æœ‰æ•°æ®
- âœ… å¿«æ·é”®æ”¯æŒï¼šCtrl+C/X/V, Meta+C/X/V

**å®ç°ä½ç½®ï¼š**
- `src/libs/drawBoard/DrawBoard.ts`

**å…³é”®ç‰¹æ€§ï¼š**
- å†…éƒ¨å‰ªè´´æ¿å­˜å‚¨ï¼ˆå†…å­˜å­˜å‚¨ï¼Œæ— éœ€æµè§ˆå™¨APIï¼‰
- è‡ªåŠ¨ç”Ÿæˆæ–°IDï¼Œé¿å…å†²çª
- æ”¯æŒåç§»ç²˜è´´ï¼ˆé»˜è®¤10pxï¼Œé¿å…å®Œå…¨é‡å ï¼‰
- ç²˜è´´åè‡ªåŠ¨é€‰ä¸­ç²˜è´´çš„å†…å®¹
- è¾¹ç•ŒéªŒè¯ï¼šç²˜è´´æ—¶è‡ªåŠ¨é™åˆ¶ç‚¹åœ¨ç”»å¸ƒèŒƒå›´å†…

### 6.2 å…¨é€‰åŠŸèƒ½

**å·²å®ç°åŠŸèƒ½ï¼š**
- âœ… `selectAll()` - é€‰æ‹©æ‰€æœ‰åŠ¨ä½œ
- âœ… å¿«æ·é”®æ”¯æŒï¼šCtrl+A, Meta+A

**å®ç°ä½ç½®ï¼š**
- `src/libs/drawBoard/DrawBoard.ts`
- `src/libs/drawBoard/tools/SelectTool.ts`ï¼ˆ`setSelectedActions()`æ–¹æ³•ï¼‰

---

## 8. è¾¹ç•ŒéªŒè¯å®ç°

### 8.1 BoundsValidatorå·¥å…·ç±»

**å®ç°ä½ç½®ï¼š**
- `src/libs/drawBoard/utils/BoundsValidator.ts`

**ä¸»è¦æ–¹æ³•ï¼š**
```typescript
// é™åˆ¶ç‚¹åœ¨ç”»å¸ƒèŒƒå›´å†…
static clampPointToCanvas(point: Point, canvasBounds: Bounds): Point

// é™åˆ¶è¾¹ç•Œæ¡†åœ¨ç”»å¸ƒèŒƒå›´å†…
static clampBoundsToCanvas(bounds: Bounds, canvasBounds: Bounds): Bounds

// ç¡®ä¿æœ€å°å°ºå¯¸
static ensureMinSize(bounds: Bounds, minSize: number): Bounds

// é™åˆ¶ç§»åŠ¨åçš„è¾¹ç•Œæ¡†
static clampMoveBounds(bounds: Bounds, deltaX: number, deltaY: number, canvasBounds: Bounds): Bounds

// é™åˆ¶ç¼©æ”¾åçš„è¾¹ç•Œæ¡†
static clampScaleBounds(bounds: Bounds, scaleX: number, scaleY: number, minSize: number, canvasBounds?: Bounds): Bounds
```

### 8.2 é›†æˆåº”ç”¨

**å·²é›†æˆä½ç½®ï¼š**
- `SelectTool.clampBoundsToCanvas()` - ä½¿ç”¨BoundsValidator
- `SelectTool.clampPointToCanvas()` - ä½¿ç”¨BoundsValidator
- `RectAnchorHandler.handleMove()` - ä½¿ç”¨BoundsValidator.clampPointToCanvas
- `CircleAnchorHandler.handleMove()` - ä½¿ç”¨BoundsValidator.clampPointToCanvas
- `LineAnchorHandler.handleMove()` - ä½¿ç”¨BoundsValidator.clampPointToCanvas
- `TextAnchorHandler.handleMove()` - ä½¿ç”¨BoundsValidator.clampPointToCanvas
- `DrawBoard.pasteSelection()` - ä½¿ç”¨BoundsValidator.clampPointToCanvas

**ä¼˜åŠ¿ï¼š**
- âœ… ç»Ÿä¸€çš„è¾¹ç•Œæ£€æŸ¥é€»è¾‘
- âœ… ç¡®ä¿å›¾å½¢åœ¨ç”»å¸ƒèŒƒå›´å†…
- âœ… ç¡®ä¿æœ€å°å°ºå¯¸è¦æ±‚
- âœ… ä»£ç å¤ç”¨ï¼Œæ˜“äºç»´æŠ¤

---

## 9. é€‰æ‹©å·¥å…·é”šç‚¹ä¼˜åŒ–

### 9.1 é”šç‚¹æ£€æµ‹ä¼˜åŒ–

**é—®é¢˜ï¼š**
- è¾¹é”šç‚¹ä½¿ç”¨çŸ©å½¢åŒºåŸŸæ£€æµ‹ï¼Œä¸å¤Ÿç²¾ç¡®
- ç§»åŠ¨åŒºåŸŸå¤ªå°ï¼Œéš¾ä»¥ç‚¹å‡»

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- ä½¿ç”¨è·ç¦»è®¡ç®—æ£€æµ‹é”šç‚¹ï¼Œé€‰æ‹©æœ€è¿‘çš„é”šç‚¹
- æ‰©å¤§ç§»åŠ¨åŒºåŸŸï¼ˆpaddingä»`anchorSize + 2`æ”¹ä¸º`anchorSize / 2`ï¼‰
- æ”¹è¿›ç§»åŠ¨åŒºåŸŸæ£€æµ‹ï¼Œæ’é™¤é”šç‚¹åŒºåŸŸ

**å®ç°ï¼š**
```typescript
private getAnchorPointAt(point: Point): {...} | null {
  // ä½¿ç”¨è·ç¦»è®¡ç®—ï¼Œé€‰æ‹©æœ€è¿‘çš„é”šç‚¹
  let closestAnchor: {...} | null = null;
  const maxDistance = this.anchorSize / 2 + this.anchorTolerance;
  
  for (let i = 0; i < this.anchorPoints.length; i++) {
    const anchor = this.anchorPoints[i];
    const anchorCenterX = anchor.x + this.anchorSize / 2;
    const anchorCenterY = anchor.y + this.anchorSize / 2;
    const distance = Math.sqrt(
      Math.pow(point.x - anchorCenterX, 2) + 
      Math.pow(point.y - anchorCenterY, 2)
    );
    
    if (distance <= maxDistance) {
      if (!closestAnchor || distance < closestAnchor.distance) {
        closestAnchor = { index: i, anchor, distance };
      }
    }
  }
  
  return closestAnchor ? {...} : null;
}
```

### 9.2 åœ†å½¢æ‹–æ‹½ä¼˜åŒ–

**é—®é¢˜ï¼š**
- åœ†å½¢æ‹–æ‹½ä½¿ç”¨å¹³æ»‘å› å­ï¼ŒåŠå¾„å˜åŒ–ä¸ç²¾ç¡®
- æ‹–æ‹½æ—¶åŠå¾„å˜åŒ–åªæœ‰60%ï¼Œä¸å¯æ§

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- ç›´æ¥ä½¿ç”¨é¼ æ ‡åˆ°åœ†å¿ƒçš„è·ç¦»ä½œä¸ºæ–°åŠå¾„
- åœ†å½¢æ‹–æ‹½ä¸åº”ç”¨æ•æ„Ÿåº¦å› å­ï¼Œä¿æŒç²¾ç¡®æ€§

**å®ç°ï¼š**
```typescript
// è®¡ç®—é¼ æ ‡åˆ°åœ†å¿ƒçš„è·ç¦»ï¼ˆè¿™å°±æ˜¯æ–°åŠå¾„ï¼‰
const mouseToCenterDistance = Math.sqrt(
  Math.pow(currentPoint.x - center.x, 2) + 
  Math.pow(currentPoint.y - center.y, 2)
);

// æ–°åŠå¾„ = é¼ æ ‡åˆ°åœ†å¿ƒçš„è·ç¦»ï¼ˆç›´æ¥ä½¿ç”¨ï¼Œç²¾ç¡®æ§åˆ¶ï¼‰
const newRadius = mouseToCenterDistance;
```

### 9.3 æ€§èƒ½ä¼˜åŒ–

**é”šç‚¹ç”Ÿæˆç¼“å­˜ï¼š**
- ç¼“å­˜TTLï¼š100ms
- åŸºäºaction IDsçš„ç¼“å­˜key
- å‡å°‘é‡å¤è®¡ç®—

**è¾¹ç•Œæ¡†ç¼“å­˜ï¼š**
- åŸºäºaction IDså’Œä¿®æ”¹æ—¶é—´çš„ç¼“å­˜key
- é¿å…é‡å¤è®¡ç®—è¾¹ç•Œæ¡†

**æ‹–æ‹½çŠ¶æ€ç¼“å­˜ï¼š**
- ç¼“å­˜æ‹–æ‹½æ“ä½œç»“æœ
- é¿å…å¾®å°ç§»åŠ¨æ—¶çš„é‡å¤è®¡ç®—

---

## 10. æ‹–æ‹½æ•æ„Ÿåº¦ä¼˜åŒ–

### 10.1 ä¼˜åŒ–å®ç°

**å®ç°ä½ç½®ï¼š**
- `src/libs/drawBoard/tools/SelectTool.ts`
- `src/libs/drawBoard/tools/anchor/CircleAnchorHandler.ts`

**ä¼˜åŒ–å‚æ•°ï¼š**
- `MIN_DRAG_DISTANCE = 3` - æœ€å°æ‹–æ‹½è·ç¦»ï¼ˆä»2å¢åŠ åˆ°3ï¼‰
- `DRAG_SENSITIVITY = 0.7` - æ‹–æ‹½æ•æ„Ÿåº¦å› å­ï¼ˆ70%ï¼Œåœ†å½¢é™¤å¤–ï¼‰
- `ANCHOR_CACHE_TTL = 100` - é”šç‚¹ç¼“å­˜TTLï¼ˆ100msï¼‰

**åº”ç”¨åœºæ™¯ï¼š**
- `handleResizeAnchorDrag()` - å•é€‰åœºæ™¯é”šç‚¹æ‹–æ‹½ï¼ˆåœ†å½¢ä¸åº”ç”¨æ•æ„Ÿåº¦ï¼‰
- `handleMultiSelectionAnchorDrag()` - å¤šé€‰åœºæ™¯é”šç‚¹æ‹–æ‹½
- `handleDefaultAnchorDrag()` - é»˜è®¤é”šç‚¹æ‹–æ‹½
- `CircleAnchorHandler.handleAnchorDrag()` - åœ†å½¢ç›´æ¥ä½¿ç”¨é¼ æ ‡è·ç¦»

**ä¼˜åŒ–æ•ˆæœï¼š**
- âœ… é”šç‚¹æ£€æµ‹ä½¿ç”¨è·ç¦»è®¡ç®—ï¼Œæé«˜å‡†ç¡®æ€§
- âœ… ç§»åŠ¨åŒºåŸŸæ‰©å¤§ï¼Œæ›´å®¹æ˜“ç‚¹å‡»åˆ°ç§»åŠ¨åŒºåŸŸ
- âœ… åœ†å½¢æ‹–æ‹½ç²¾ç¡®æ§åˆ¶ï¼ŒåŠå¾„ç›´æ¥è·Ÿéšé¼ æ ‡
- âœ… é”šç‚¹ç”Ÿæˆç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®—
- âœ… è¾¹ç•Œæ¡†ç¼“å­˜ï¼Œæå‡æ€§èƒ½

---

## 9. æ€»ç»“

DrawBoard çš„å®ç°é‡‡ç”¨äº†æ¨¡å—åŒ–ã€å¯æ‰©å±•çš„æ¶æ„è®¾è®¡ï¼Œé€šè¿‡åŠ¨æ€å›¾å±‚ç³»ç»Ÿè§£å†³äº†äº¤äº’å…ƒç´ é®æŒ¡é—®é¢˜ï¼Œé€šè¿‡å®Œå–„çš„é”šç‚¹äº¤äº’è§„èŒƒæä¾›äº†ç›´è§‚çš„ç”¨æˆ·ä½“éªŒã€‚æ‰€æœ‰å…³é”®åŠŸèƒ½éƒ½å·²å®ç°å¹¶é€šè¿‡æµ‹è¯•ï¼Œç³»ç»Ÿç¨³å®šå¯é ã€‚

**å®ç°ç‰¹ç‚¹ï¼š**
- âœ… **æ¨¡å—åŒ–è®¾è®¡** - èŒè´£åˆ†ç¦»ï¼Œæ˜“äºç»´æŠ¤
- âœ… **æ€§èƒ½ä¼˜åŒ–** - å›¾å±‚ç¼“å­˜ã€ç¦»å±ç¼“å­˜ï¼ŒæŒ‰éœ€æ¸²æŸ“
- âœ… **ç”¨æˆ·ä½“éªŒ** - ç›´è§‚çš„äº¤äº’è®¾è®¡
- âœ… **å¯æ‰©å±•æ€§** - æ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- âœ… **ä»£ç è´¨é‡** - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2024  
**ç»´æŠ¤è€…**: DrawBoardå¼€å‘å›¢é˜Ÿ

